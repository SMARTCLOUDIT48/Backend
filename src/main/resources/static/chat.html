<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LangMate - Global Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        /* --- 1. ì „ì²´ ë ˆì´ì•„ì›ƒ (ì¢Œìš° ë¶„í• ) --- */
        body {
            background-color: #f4f6f9;
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container {
            width: 1200px; /* ì „ì²´ ë„ˆë¹„ */
            height: 90vh;  /* ì „ì²´ ë†’ì´ */
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            overflow: hidden; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ìœ ì§€ */
        }

        /* --- 2. ì™¼ìª½ ì‚¬ì´ë“œë°” (ì±„íŒ…ë°© ëª©ë¡) --- */
        .sidebar {
            width: 350px;
            background-color: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .room-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .room-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            transition: 0.2s;
        }
        .room-item:hover { background-color: #fff; }
        .room-item.active { background-color: #e3f2fd; border-left: 4px solid #1976d2; }

        .room-avatar {
            width: 45px; height: 45px;
            border-radius: 50%; background: #ddd;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        .room-info { flex: 1; }
        .room-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; color: #333; }
        .room-last-msg { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }

        /* --- 3. ì˜¤ë¥¸ìª½ ë©”ì¸ ì±„íŒ… ì˜ì—­ --- */
        .chat-area {
            flex: 1; /* ë‚¨ì€ ê³µê°„ ë‹¤ ì°¨ì§€ */
            display: flex;
            flex-direction: column;
            background-color: #fff;
        }

        .chat-header {
            padding: 15px 25px;
            border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            height: 50px;
        }
        .chat-title { font-size: 16px; font-weight: bold; }
        .chat-status { font-size: 12px; color: #666; }

        .message-box {
            flex: 1; /* ë†’ì´ ìœ ì—°í•˜ê²Œ */
            padding: 20px;
            overflow-y: auto;
            background-color: #fdfdfd;
            list-style: none; margin: 0;
        }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€ + ë‹¤ë“¬ê¸°) */
        .message-li { margin-bottom: 15px; display: flex; flex-direction: column; }
        .bubble { display: inline-block; padding: 10px 14px; border-radius: 12px; max-width: 70%; font-size: 14px; line-height: 1.5; word-wrap: break-word; }

        .me { align-items: flex-end; }
        .me .bubble { background-color: #ffeb33; margin-left: 5px; border-top-right-radius: 0; }

        .other { align-items: flex-start; }
        .other .bubble { background-color: #f1f3f5; margin-right: 5px; border-top-left-radius: 0; }
        .sender { font-size: 12px; margin-bottom: 5px; color: #666; padding-left: 5px; }

        .center { align-items: center; }
        .center .bubble { background-color: rgba(0,0,0,0.05); color: #555; font-size: 12px; border-radius: 20px; }

        /* --- 4. ì…ë ¥ì°½ ì˜ì—­ (ê³ ì • ì•„ë‹˜, Flex ë‚´ë¶€ ë°°ì¹˜) --- */
        .input-area {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #fff;
        }

        /* ë…¹ìŒ ë¯¸ë¦¬ë³´ê¸° */
        #preview-box {
            display: none; padding: 10px; margin-bottom: 10px;
            background: #f8f9fa; border-radius: 8px; border: 1px solid #eee;
            align-items: center; justify-content: space-between;
        }

        .input-wrapper { display: flex; gap: 10px; align-items: center; }
        #msg {
            flex: 1; padding: 12px;
            border: 1px solid #ddd; border-radius: 8px;
            outline: none; background: #f8f9fa; transition: 0.2s;
        }
        #msg:focus { border-color: #1976d2; background: #fff; }

        .btn-group { display: flex; gap: 5px; }
        button {
            border: none; border-radius: 8px;
            width: 40px; height: 40px;
            cursor: pointer; font-size: 16px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }

        #btn-mic { background: #f1f3f5; color: #555; }
        #btn-grammar { background: #e3f2fd; color: #1976d2; }
        #btn-tone { background: #fce4ec; color: #d81b60; }
        #btn-send { background: #ffeb33; color: #333; width: 60px; font-weight: bold; font-size: 14px; }

        /* ë…¹ìŒ ì¤‘ ì• ë‹ˆë©”ì´ì…˜ */
        .recording { background-color: #ff3b30 !important; color: white !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* AI ì²¨ì‚­ ìŠ¤íƒ€ì¼ */
        .correction-bubble { background: #e3f2fd !important; border: 1px solid #90caf9; width: 80%; }
        .correction-btn { width: 100%; margin-top: 5px; padding: 5px; background: white; border: 1px solid #90caf9; color: #1565c0; border-radius: 4px; cursor: pointer; }

    </style>
</head>
<body>

<div class="app-container">

    <div class="sidebar">
        <div class="sidebar-header">
            ì±„íŒ… ëª©ë¡ ğŸ’¬
        </div>
        <ul class="room-list" id="roomListArea">
        </ul>
    </div>

    <div class="chat-area">

        <div class="chat-header">
            <div class="chat-title" id="roomTitle">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            <div class="chat-status" id="connectionStatus">ğŸ”´ ì—°ê²° ì•ˆë¨</div>
        </div>

        <ul id="messageList" class="message-box">
            <li class="message-li center"><div class="bubble">ì™¼ìª½ ëª©ë¡ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”.</div></li>
        </ul>

        <div class="input-area">
            <div id="preview-box">
                <audio id="preview-player" controls style="height:30px; flex:1; margin-right:10px;"></audio>
                <button onclick="cancelVoice()" style="width:30px; height:30px; background:#ff5252; color:white; font-size:12px;">X</button>
            </div>

            <div class="input-wrapper">
                <input type="text" id="msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMessage()">

                <div class="btn-group">
                    <button id="btn-mic" onclick="toggleRecording()" title="ìŒì„± ë…¹ìŒ">ğŸ¤</button>
                    <button id="btn-grammar" onclick="checkGrammar()" title="ë¬¸ë²• ê²€ì‚¬">ğŸ“</button>
                    <button id="btn-tone" onclick="checkTone()" title="ê°ì • ë¶„ì„">â¤ï¸</button>
                    <button id="btn-send" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- 1. ê°€ì§œ ë°ì´í„° (ë‚˜ì¤‘ì—ëŠ” DBì—ì„œ ë¶ˆëŸ¬ì™€ì•¼ í•¨) ---
    const myChatRooms = [
        // idë¥¼ "room1" (ë¬¸ì) -> 1 (ìˆ«ì)ë¡œ ë³€ê²½!
        { id: 1, name: "ë“œë¼ë§ˆì¹œêµ¬ ğŸ¿", lastMsg: "ìŠ¤í† ë„ˆ ë“œë¼ë§ˆ ìˆì–´ìš”?", avatar: "ğŸ¬" },
        { id: 2, name: "Alex (English) ğŸ‡ºğŸ‡¸", lastMsg: "How are you doing?", avatar: "ğŸ‡ºğŸ‡¸" },
        { id: 3, name: "ê°œë°œì ëª¨ì„ ğŸ’»", lastMsg: "ì„œë²„ ë°°í¬ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.", avatar: "ğŸ’»" }
    ];
    // --- 2. ì „ì—­ ë³€ìˆ˜ ---
    var stompClient = null;
    var currentRoomId = null;
    var mySenderId = 1;
    var mySenderName = "íŒ€ì¥ë‹˜";
    var subscription = null; // í˜„ì¬ êµ¬ë… ì •ë³´ ì €ì¥ (ë°© ì˜®ê¸¸ ë•Œ ëŠê¸° ìœ„í•´)

    // --- 3. ì´ˆê¸°í™” (í™”ë©´ ë¡œë“œì‹œ ëª©ë¡ ê·¸ë¦¬ê¸°) ---
    window.onload = function() {
        renderRoomList();
    };

    function renderRoomList() {
        var listArea = document.getElementById("roomListArea");
        listArea.innerHTML = ""; // ì´ˆê¸°í™”

        myChatRooms.forEach(room => {
            var li = document.createElement("li");
            li.className = "room-item";
            li.onclick = function() { enterRoom(room.id, room.name); }; // í´ë¦­ ì´ë²¤íŠ¸
            li.innerHTML = `
                <div class="room-avatar">${room.avatar}</div>
                <div class="room-info">
                    <div class="room-name">${room.name}</div>
                    <div class="room-last-msg">${room.lastMsg}</div>
                </div>
            `;
            listArea.appendChild(li);
        });
    }

    // --- 4. ë°© ì…ì¥ (í´ë¦­ ì‹œ ì‹¤í–‰) ---
    function enterRoom(roomId, roomName) {
        if (currentRoomId === roomId) return; // ì´ë¯¸ ë“¤ì–´ì˜¨ ë°©ì´ë©´ ë¬´ì‹œ

        currentRoomId = roomId;
        document.getElementById("roomTitle").innerText = roomName;
        document.getElementById("messageList").innerHTML = ""; // ì´ì „ ë©”ì‹œì§€ ì²­ì†Œ

        // UI í™œì„±í™” í‘œì‹œ
        var items = document.querySelectorAll(".room-item");
        items.forEach(item => item.classList.remove("active"));
        event.currentTarget.classList.add("active");

        connect(roomId); // ì†Œì¼“ ì—°ê²° ì‹œë„
    }

    // --- 5. ì†Œì¼“ ì—°ê²° ---
    function connect(roomId) {
        // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´ ê¸°ì¡´ êµ¬ë… í•´ì œ í›„ ì¬êµ¬ë…
        if (stompClient && stompClient.connected) {
            if (subscription) subscription.unsubscribe(); // ê¸°ì¡´ ë°© êµ¬ë… ì·¨ì†Œ
            subscribeToRoom(roomId);
            return;
        }

        var socket = new WebSocket('ws://localhost:8080/ws/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            document.getElementById("connectionStatus").innerText = "ğŸŸ¢ ì‹¤ì‹œê°„ ì—°ê²°ë¨";
            document.getElementById("connectionStatus").style.color = "green";
            subscribeToRoom(roomId);
        });
    }

    function subscribeToRoom(roomId) {
        // êµ¬ë…í•˜ê³  ê²°ê³¼ë¥¼ ë³€ìˆ˜ì— ì €ì¥ (ë‚˜ì¤‘ì— í•´ì œí•  ìˆ˜ ìˆê²Œ)
        subscription = stompClient.subscribe('/sub/chat/room/' + roomId, function (message) {
            showUi(JSON.parse(message.body));
        });

        // ì…ì¥ ë©”ì‹œì§€ ì „ì†¡ (ì„ íƒì‚¬í•­)
        // stompClient.send("/pub/chat/message", {}, JSON.stringify({
        //     type: 'ENTER', roomId: roomId, sender: mySenderName, senderId: mySenderId, message: ''
        // }));

        // DBì—ì„œ ì´ì „ ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸° (API êµ¬í˜„ë˜ì–´ ìˆë‹¤ë©´)
        loadChatHistory(roomId);
    }

    // --- UI ë Œë”ë§ í•¨ìˆ˜ ---
    function showUi(message) {
        var ul = document.getElementById("messageList");
        var li = document.createElement("li");
        var type = message.type;
        var senderId = message.senderId;
        var content = message.message;

        if (type === 'VOICE') {
            li.className = (senderId == mySenderId) ? "message-li me" : "message-li other";
            var audioPlayer = `<audio controls src="${content}" style="height:30px; width:220px;"></audio>`;
            li.innerHTML = `<div class="sender">${message.sender}</div><div class="bubble" style="padding:5px;">${audioPlayer}</div>`;
        }
        else if (type === 'CORRECT') {
            // ... (ê¸°ì¡´ AI ë¡œì§)
        }
        else { // ì¼ë°˜ í…ìŠ¤íŠ¸
            li.className = (senderId == mySenderId) ? "message-li me" : "message-li other";
            li.innerHTML = `<div class="sender">${message.sender}</div><div class="bubble">${content}</div>`;
        }
        ul.appendChild(li);
        ul.scrollTop = ul.scrollHeight; // ìŠ¤í¬ë¡¤ í•˜ë‹¨ ì´ë™
    }

    // --- ê¸°íƒ€ ê¸°ëŠ¥ (ë…¹ìŒ, AI ë“± ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
    var mediaRecorder = null;
    var audioChunks = [];
    var currentVoiceBlob = null;
    var isRecording = false;

    function toggleRecording() {
        if (!isRecording) startRecording();
        else stopRecording();
    }

    function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) audioChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                currentVoiceBlob = new Blob(audioChunks, { type: 'audio/webm' });
                document.getElementById("preview-player").src = URL.createObjectURL(currentVoiceBlob);
                document.getElementById("preview-box").style.display = "flex";
            };
            mediaRecorder.start();
            isRecording = true;
            document.getElementById("btn-mic").classList.add("recording");
        });
    }

    function stopRecording() {
        if(mediaRecorder) mediaRecorder.stop();
        isRecording = false;
        document.getElementById("btn-mic").classList.remove("recording");
    }

    function cancelVoice() {
        currentVoiceBlob = null;
        document.getElementById("preview-box").style.display = "none";
    }

    function sendMessage() {
        if (!currentRoomId) { alert("ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }

        if (currentVoiceBlob) {
            uploadAndSendVoice();
        } else {
            var msgInput = document.getElementById("msg");
            if (msgInput.value && stompClient) {
                stompClient.send("/pub/chat/message", {}, JSON.stringify({
                    type: 'TALK', roomId: currentRoomId, sender: mySenderName, senderId: mySenderId, message: msgInput.value
                }));
                msgInput.value = '';
            }
        }
    }

    function uploadAndSendVoice() {
        var formData = new FormData();
        formData.append("file", currentVoiceBlob, "voice.webm");
        fetch("/api/file/upload", { method: "POST", body: formData })
            .then(r => r.json())
            .then(data => {
                stompClient.send("/pub/chat/message", {}, JSON.stringify({
                    type: 'VOICE', roomId: currentRoomId, sender: mySenderName, senderId: mySenderId, message: data.url
                }));
                cancelVoice();
            });
    }

    function checkGrammar() {
        var text = document.getElementById("msg").value;
        if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

        var btn = document.getElementById("btn-grammar");
        btn.innerText = "â³";

        fetch("/api/bot/grammar", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
        }).then(r => r.json()).then(data => {
            var ul = document.getElementById("messageList");
            var li = document.createElement("li");
            li.className = "message-li center";
            li.innerHTML = `
                <div class="bubble correction-bubble">
                    <b>ğŸ¤– AI ì„ ìƒë‹˜</b><br>
                    <s>${data.original}</s><br>
                    <b style="color:blue">â¡ï¸ ${data.corrected}</b><br>
                    <small>${data.explanation}</small>
                    <button class="correction-btn" onclick="document.getElementById('msg').value='${data.corrected}'">ì ìš©í•˜ê¸°</button>
                </div>
            `;
            ul.appendChild(li);
            ul.scrollTop = ul.scrollHeight;
            btn.innerText = "ğŸ“";
        });
    }

    function checkTone() { alert("í˜¸ê°ë„ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘"); }
    function loadChatHistory(rid) {
        // fetch("/chat/history/" + rid).then... (êµ¬í˜„ í•„ìš”)
    }

</script>
</body>
</html>