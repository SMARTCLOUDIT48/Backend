<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LangMate - Global Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        /* --- CSS ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) --- */
        body { background-color: #f4f6f9; font-family: 'Malgun Gothic', sans-serif; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; }
        .app-container { width: 1200px; height: 90vh; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; overflow: hidden; }
        .sidebar { width: 350px; background-color: #f8f9fa; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #eee; color: #333; }
        .room-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .room-item { padding: 15px 20px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #f1f1f1; transition: 0.2s; }
        .room-item:hover { background-color: #fff; }
        .room-item.active { background-color: #e3f2fd; border-left: 4px solid #1976d2; }
        .room-avatar { width: 45px; height: 45px; border-radius: 50%; background: #ddd; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .room-info { flex: 1; }
        .room-name { font-weight: bold; font-size: 14px; margin-bottom: 5px; color: #333; }
        .room-last-msg { font-size: 12px; color: #888; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: #fff; position: relative; } /* position: relative ì¶”ê°€ */
        .chat-header { padding: 15px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; height: 50px; }
        .chat-title { font-size: 16px; font-weight: bold; }
        .chat-status { font-size: 12px; color: #666; }
        .message-box { flex: 1; padding: 20px; overflow-y: auto; background-color: #fdfdfd; list-style: none; margin: 0; }
        .message-li { margin-bottom: 15px; display: flex; flex-direction: column; }
        .bubble { display: inline-block; padding: 10px 14px; border-radius: 12px; max-width: 70%; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .me { align-items: flex-end; } .me .bubble { background-color: #ffeb33; margin-left: 5px; border-top-right-radius: 0; }
        .other { align-items: flex-start; } .other .bubble { background-color: #f1f3f5; margin-right: 5px; border-top-left-radius: 0; }
        .sender { font-size: 12px; margin-bottom: 5px; color: #666; padding-left: 5px; }
        .center { align-items: center; } .center .bubble { background-color: rgba(0,0,0,0.05); color: #555; font-size: 12px; border-radius: 20px; }
        .input-area { padding: 20px; border-top: 1px solid #eee; background: #fff; }
        #preview-box { display: none; padding: 10px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; align-items: center; justify-content: space-between; }
        .input-wrapper { display: flex; gap: 10px; align-items: center; }
        #msg { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; background: #f8f9fa; }
        #msg:focus { border-color: #1976d2; background: #fff; }
        .btn-group { display: flex; gap: 5px; }
        button { border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        #btn-send { background: #ffeb33; color: #333; width: 60px; font-weight: bold; font-size: 14px; }
        .recording { background-color: #ff3b30 !important; color: white !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* âœ¨ AI ëª¨ë‹¬ì°½ ìŠ¤íƒ€ì¼ ì¶”ê°€ âœ¨ */
        .ai-modal { display: none; position: absolute; bottom: 80px; left: 20px; right: 20px; background: white; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); padding: 20px; z-index: 100; }
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .ai-title { font-weight: bold; font-size: 16px; color: #1976d2; }
        .ai-close { cursor: pointer; font-weight: bold; color: #999; }
        .ai-result-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .ai-corrected { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .ai-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .ai-tab { padding: 5px 12px; border-radius: 15px; font-size: 12px; cursor: pointer; border: 1px solid #ddd; background: white; }
        .ai-tab.active { background: #1976d2; color: white; border-color: #1976d2; }
        .ai-explanation { font-size: 14px; line-height: 1.5; color: #555; }
        #btn-ai { background: #e3f2fd; color: #1976d2; width: 40px; } /* AI ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">ì±„íŒ… ëª©ë¡ ğŸ’¬</div>
        <ul class="room-list" id="roomListArea"></ul>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-title" id="roomTitle">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            <div class="chat-status" id="connectionStatus">ğŸ”´ ì—°ê²° ì•ˆë¨</div>
        </div>

        <ul id="messageList" class="message-box">
            <li class="message-li center"><div class="bubble">ì™¼ìª½ ëª©ë¡ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”.</div></li>
        </ul>

        <div id="aiModal" class="ai-modal">
            <div class="ai-header">
                <div class="ai-title">ğŸ¤– AI ë¬¸ë²• ì„ ìƒë‹˜</div>
                <div class="ai-close" onclick="closeAiModal()">X</div>
            </div>
            <div class="ai-result-box">
                <div class="ai-corrected" id="aiCorrectedText">Checking...</div>
            </div>
            <div class="ai-tabs">
                <div class="ai-tab active" id="tabKr" onclick="switchTab('kr')">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ì„¤ëª…</div>
                <div class="ai-tab" id="tabJp" onclick="switchTab('jp')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª èª¬æ˜</div>
            </div>
            <div class="ai-explanation" id="aiExplanationText">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>

            <button onclick="applyCorrection()" style="width:100%; margin-top:10px; background:#333; color:white; height:35px; font-size:13px;">ì…ë ¥ì°½ì— ì ìš©í•˜ê¸°</button>
        </div>

        <div class="input-area">
            <div id="preview-box">
                <audio id="preview-player" controls style="height:30px; flex:1; margin-right:10px;"></audio>
                <button onclick="cancelVoice()" style="width:30px; height:30px; background:#ff5252; color:white;">X</button>
            </div>
            <div class="input-wrapper">
                <input type="text" id="msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.keyCode==13) sendMessage()">
                <div class="btn-group">
                    <button id="btn-ai" onclick="checkGrammar()" title="ë¬¸ë²• ê²€ì‚¬">ğŸ¤–</button>
                    <button id="btn-mic" onclick="toggleRecording()" title="ìŒì„± ë…¹ìŒ">ğŸ¤</button>
                    <button id="btn-send" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
    var stompClient = null;
    var currentRoomId = null;
    var mySenderId = 1;     // ì„ì‹œ ID (ì‹¤ì œë¡  ë¡œê·¸ì¸ ì„¸ì…˜ì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
    var mySenderName = "íŒ€ì¥ë‹˜"; // ì„ì‹œ ì´ë¦„
    var subscription = null;

    // âœ¨ AI ë°ì´í„° ì €ì¥ìš© ë³€ìˆ˜
    var aiData = {};

    // --- 2. í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
    document.addEventListener('DOMContentLoaded', () => {
        loadChatRooms(); // ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    });

    // --- 3. ì±„íŒ…ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ---
    function loadChatRooms() {
        fetch('/api/chat/rooms') // RoomControllerì˜ ê²½ë¡œ
            .then(res => res.json())
            .then(rooms => {
                const listArea = document.getElementById("roomListArea");
                listArea.innerHTML = "";
                rooms.forEach(room => {
                    const li = document.createElement("li");
                    li.className = "room-item";
                    li.onclick = () => enterRoom(room.id, room.name, li); // í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
                    li.innerHTML = `
                        <div class="room-avatar">ğŸ’¬</div>
                        <div class="room-info">
                            <div class="room-name">${room.name}</div>
                            <div class="room-last-msg">ID: ${room.id}</div>
                        </div>`;
                    listArea.appendChild(li);
                });
            });
    }

    // --- 4. ë°© ì…ì¥ ë° ì†Œì¼“ ì—°ê²° ---
    function enterRoom(roomId, roomName, element) {
        if (currentRoomId === roomId) return;

        currentRoomId = roomId;
        document.getElementById("roomTitle").innerText = roomName;
        document.getElementById("messageList").innerHTML = ""; // í™”ë©´ ì´ˆê¸°í™”

        // UI í™œì„±í™” íš¨ê³¼
        document.querySelectorAll(".room-item").forEach(item => item.classList.remove("active"));
        if(element) element.classList.add("active");

        connect(roomId); // ì†Œì¼“ ì—°ê²° ì‹œì‘
    }

    function connect(roomId) {
        // ì´ë¯¸ ì—°ê²°ëœ ìƒíƒœë¼ë©´ êµ¬ë…ë§Œ ë³€ê²½
        if (stompClient && stompClient.connected) {
            subscribeToRoom(roomId);
            return;
        }

        var socket = new WebSocket('ws://localhost:8080/ws/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            document.getElementById("connectionStatus").innerText = "ğŸŸ¢ ì‹¤ì‹œê°„ ì—°ê²°ë¨";
            document.getElementById("connectionStatus").style.color = "green";
            subscribeToRoom(roomId);
        });
    }

    function subscribeToRoom(roomId) {
        // ì´ì „ ë°© êµ¬ë… í•´ì œ (ì¤‘ë³µ ìˆ˜ì‹  ë°©ì§€)
        if (subscription) {
            subscription.unsubscribe();
        }

        // ìƒˆ ë°© êµ¬ë…
        subscription = stompClient.subscribe('/sub/chat/room/' + roomId, function (message) {
            showUi(JSON.parse(message.body));
        });

        // â­ ì¤‘ìš”: ì…ì¥í•˜ìë§ˆì ì´ì „ ëŒ€í™” ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
        loadChatHistory(roomId);
    }

    // --- 5. ì´ì „ ëŒ€í™” ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ---
    function loadChatHistory(roomId) {
        fetch('/chat/history/' + roomId)
            .then(res => {
                if (!res.ok) throw new Error("Load failed");
                return res.json();
            })
            .then(messages => {
                const ul = document.getElementById("messageList");
                ul.innerHTML = ""; // ë¡œë”© ì „ ì´ˆê¸°í™”

                if (messages.length > 0) {
                    messages.forEach(msg => {
                        showUi({
                            type: msg.type,
                            sender: msg.sender,
                            senderId: msg.senderId,
                            message: msg.message // DTO í•„ë“œëª… ë§¤ì¹­
                        });
                    });
                    showSystemMessage("--- ì´ì „ ëŒ€í™” ë‚´ì—­ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ ---");
                } else {
                    showSystemMessage("ì´ì „ ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            })
            .catch(err => console.error(err));
    }

    // --- 6. í™”ë©´ì— ë©”ì‹œì§€ ê·¸ë¦¬ê¸° ---
    function showUi(message) {
        var ul = document.getElementById("messageList");
        var li = document.createElement("li");

        var isMe = (message.senderId == mySenderId);
        li.className = isMe ? "message-li me" : "message-li other";

        if (message.type === 'VOICE') {
            li.innerHTML = `<div class="sender">${message.sender}</div>
                            <div class="bubble" style="padding:5px;">
                                <audio controls src="${message.message}" style="height:30px; width:220px;"></audio>
                            </div>`;
        } else {
            li.innerHTML = `<div class="sender">${message.sender}</div>
                            <div class="bubble">${message.message}</div>`;
        }

        ul.appendChild(li);
        ul.scrollTop = ul.scrollHeight;
    }

    function showSystemMessage(text) {
        var ul = document.getElementById("messageList");
        var li = document.createElement("li");
        li.className = "message-li center";
        li.innerHTML = `<div class="bubble">${text}</div>`;
        ul.appendChild(li);
        ul.scrollTop = ul.scrollHeight;
    }

    // --- 7. ë©”ì‹œì§€ ì „ì†¡ ë¡œì§ ---
    function sendMessage() {
        if (!currentRoomId) { alert("ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }

        // ìŒì„± ë©”ì‹œì§€ ì²˜ë¦¬
        if (currentVoiceBlob) {
            uploadAndSendVoice();
            return;
        }

        // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì²˜ë¦¬
        var msgInput = document.getElementById("msg");
        if (msgInput.value && stompClient) {
            stompClient.send("/pub/chat/message", {}, JSON.stringify({
                type: 'TALK',
                roomId: currentRoomId,
                sender: mySenderName,
                senderId: mySenderId,
                message: msgInput.value
            }));
            msgInput.value = '';
        }
    }

    // --- 8. ë…¹ìŒ ê¸°ëŠ¥ (ê°„ì†Œí™”) ---
    var mediaRecorder = null;
    var audioChunks = [];
    var currentVoiceBlob = null;
    var isRecording = false;

    function toggleRecording() {
        if (!isRecording) {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    currentVoiceBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    document.getElementById("preview-player").src = URL.createObjectURL(currentVoiceBlob);
                    document.getElementById("preview-box").style.display = "flex";
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById("btn-mic").classList.add("recording");
            });
        } else {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById("btn-mic").classList.remove("recording");
        }
    }

    function cancelVoice() {
        currentVoiceBlob = null;
        document.getElementById("preview-box").style.display = "none";
    }

    function uploadAndSendVoice() {
        var formData = new FormData();
        formData.append("file", currentVoiceBlob, "voice.webm");

        fetch("/api/file/upload", { method: "POST", body: formData })
            .then(r => r.json())
            .then(data => {
                stompClient.send("/pub/chat/message", {}, JSON.stringify({
                    type: 'VOICE', roomId: currentRoomId, sender: mySenderName, senderId: mySenderId, message: data.url
                }));
                cancelVoice();
            });
    }

    // ==========================================================
    // âœ¨âœ¨âœ¨ 9. AI ë¬¸ë²• ê²€ì‚¬ ê¸°ëŠ¥ (ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤!) âœ¨âœ¨âœ¨
    // ==========================================================

    function checkGrammar() {
        var msgInput = document.getElementById("msg");
        var text = msgInput.value.trim();

        if (!text) {
            alert("ê²€ì‚¬í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        // ëª¨ë‹¬ì°½ ì—´ê³  ë¡œë”© í‘œì‹œ
        document.getElementById("aiModal").style.display = 'block';
        document.getElementById("aiCorrectedText").innerText = "AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤... ğŸ§ ";
        document.getElementById("aiExplanationText").innerText = "";

        // API í˜¸ì¶œ
        fetch('/api/ai/grammar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "message": text })
        })
            .then(response => response.json())
            .then(data => {
                console.log("AI ê²°ê³¼:", data);
                aiData = data; // ê²°ê³¼ ì €ì¥ (íƒ­ ì „í™˜ìš©)

                // ê²°ê³¼ í™”ë©´ì— ë¿Œë¦¬ê¸°
                document.getElementById("aiCorrectedText").innerText = data.corrected;

                // ê¸°ë³¸ì€ í•œêµ­ì–´ íƒ­ í™œì„±í™”
                switchTab('kr');
            })
            .catch(error => {
                console.error(error);
                document.getElementById("aiCorrectedText").innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                document.getElementById("aiExplanationText").innerText = "ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            });
    }

    function switchTab(lang) {
        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
        if (!aiData.corrected) return;

        // íƒ­ ìŠ¤íƒ€ì¼ ë³€ê²½
        document.getElementById("tabKr").className = (lang === 'kr') ? "ai-tab active" : "ai-tab";
        document.getElementById("tabJp").className = (lang === 'jp') ? "ai-tab active" : "ai-tab";

        // ë‚´ìš© ë³€ê²½ (ì €ì¥í•´ë‘” ë°ì´í„°ì—ì„œ êº¼ë‚´ì˜¤ê¸°)
        var explanationDiv = document.getElementById("aiExplanationText");
        if (lang === 'kr') {
            explanationDiv.innerText = aiData.explanation_kr || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
        } else {
            explanationDiv.innerText = aiData.explanation_jp || "èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        }
    }

    function closeAiModal() {
        document.getElementById("aiModal").style.display = 'none';
    }

    function applyCorrection() {
        if (aiData.corrected) {
            document.getElementById("msg").value = aiData.corrected;
            closeAiModal();
        }
    }
</script>
</body>
</html>