<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Global Chat - Voice Toggle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* --- Í∏∞Î≥∏ Ïä§ÌÉÄÏùº (Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ) --- */
        body { background-color: #b2c7d9; font-family: 'Malgun Gothic', sans-serif; margin: 0; }
        .chat-container { width: 100%; max-width: 500px; margin: 0 auto; background-color: #b2c7d9; height: 100vh; display: flex; flex-direction: column; }
        .message-box { flex: 1; list-style: none; padding: 20px; margin: 0; overflow-y: auto; padding-bottom: 120px; }
        .message-li { margin-bottom: 15px; display: flex; flex-direction: column; }

        .bubble { display: inline-block; padding: 8px 12px; border-radius: 10px; max-width: 75%; font-size: 14px; word-wrap: break-word; box-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .me { align-items: flex-end; }
        .me .bubble { background-color: #ffeb33; margin-left: 5px; }
        .other { align-items: flex-start; }
        .other .bubble { background-color: #ffffff; margin-right: 5px; cursor: pointer; }
        .other .sender { font-size: 12px; margin-bottom: 5px; color: #555; padding-left: 5px; }
        .center { align-items: center; }
        .center .bubble { background-color: rgba(0,0,0,0.05); color: #555; font-size: 12px; padding: 4px 10px; border-radius: 20px; box-shadow: none; }
        .time { font-size: 10px; color: #555; margin-left: 5px; vertical-align: bottom; }

        .correction-bubble { background-color: #e3f2fd !important; border: 1px solid #90caf9; }
        .correction-title { display: block; font-weight: bold; color: #1976d2; font-size: 12px; margin-bottom: 5px; }

        /* --- ÌïòÎã® ÏòÅÏó≠ --- */
        .bottom-area {
            position: fixed; bottom: 0; width: 100%; max-width: 500px;
            background: #ffffff; border-top: 1px solid #ddd;
            display: flex; flex-direction: column;
        }

        #preview-box {
            display: none;
            padding: 10px; background-color: #f9f9f9; border-bottom: 1px solid #eee;
            align-items: center; justify-content: space-between;
        }
        #preview-player { width: 80%; height: 30px; }
        #btn-cancel-voice {
            background: #ff5252; color: white; border-radius: 50%; width: 25px; height: 25px;
            display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;
        }

        .input-wrapper { padding: 8px; display: flex; align-items: center; }
        #msg { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }

        .btn-group { display: flex; gap: 3px; margin-left: 5px; }
        button { border: none; border-radius: 4px; padding: 0 10px; height: 38px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }

        #btn-grammar { background-color: #e1f5fe; color: #0277bd; border: 1px solid #b3e5fc; }
        #btn-tone { background-color: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0; }
        #btn-send { background-color: #ffeb33; color: #333; padding: 0 15px; font-size: 14px; }

        #btn-mic { background-color: #eee; color: #333; border: 1px solid #ccc; font-size: 16px; }
        /* ÎÖπÏùå Ï§ëÏùº Îïå ÍπúÎπ°Ïù¥Îäî Ìö®Í≥º */
        .recording { background-color: #ff3b30 !important; color: white !important; animation: pulse 1s infinite; border-radius: 10px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="chat-container">
    <div style="padding: 10px; background: rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 16px;">üöÄ Í∏ÄÎ°úÎ≤å Ï±ÑÌåÖ (Voice)</h3>
        <div>
            <button onclick="connect()" style="height:30px;">Ï†ëÏÜç</button>
            <button onclick="disconnect()" style="height:30px;">Ï¢ÖÎ£å</button>
        </div>
    </div>
    <ul id="messageList" class="message-box"></ul>
</div>

<div class="bottom-area">
    <div id="preview-box">
        <span style="font-size: 12px; color: #555; margin-right: 5px;">ÏùåÏÑ± ÎåÄÍ∏∞Ï§ë:</span>
        <audio id="preview-player" controls></audio>
        <div id="btn-cancel-voice" onclick="cancelVoice()" title="ÎÖπÏùå Ï∑®ÏÜå">X</div>
    </div>

    <div class="input-wrapper">
        <input type="text" id="msg" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." onkeypress="if(event.keyCode==13) sendMessage()">

        <div class="btn-group">
            <button id="btn-mic" onclick="toggleRecording()" title="ÌÅ¥Î¶≠ÌïòÏó¨ ÎÖπÏùå ÏãúÏûë/Ï§ëÎ£å">üé§</button>

            <button id="btn-grammar" onclick="checkGrammar()" title="Î¨∏Î≤ï Í≤ÄÏÇ¨">üìù</button>
            <button id="btn-tone" onclick="checkTone()" title="Ìò∏Í∞êÎèÑ Í≤ÄÏÇ¨">‚ù§Ô∏è</button>
            <button id="btn-send" onclick="sendMessage()">Ï†ÑÏÜ°</button>
        </div>
    </div>
</div>

<script>
    var stompClient = null;
    var currentRoomId = "1";
    var mySenderId = 1;
    var mySenderName = "ÌåÄÏû•Îãò";

    // --- ÎÖπÏùå Í¥ÄÎ†® Î≥ÄÏàò ---
    var mediaRecorder = null;
    var audioChunks = [];
    var currentVoiceBlob = null;
    var isRecording = false; // ‚òÖ ÎÖπÏùå ÏÉÅÌÉú Ï≤¥ÌÅ¨Ïö© Î≥ÄÏàò

    function connect() {
        var socket = new WebSocket('ws://localhost:8080/ws/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/sub/chat/room/' + currentRoomId, function (message) {
                showUi(JSON.parse(message.body));
            });
            stompClient.send("/pub/chat/message", {}, JSON.stringify({
                type: 'ENTER', roomId: currentRoomId, sender: mySenderName, senderId: mySenderId, message: ''
            }));
            loadChatHistory();
        });
    }

    // ‚òÖ [ÌïµÏã¨] ÌÜ†Í∏Ä Í∏∞Îä• Íµ¨ÌòÑ
    function toggleRecording() {
        if (!isRecording) {
            // ÎÖπÏùå ÏãúÏûë
            startRecording();
        } else {
            // ÎÖπÏùå Ï§ëÏßÄ (Ï†ÄÏû• Î∞è ÎØ∏Î¶¨Î≥¥Í∏∞)
            stopRecording();
        }
    }

    function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => {
                    if(e.data.size > 0) audioChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    currentVoiceBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    var audioUrl = URL.createObjectURL(currentVoiceBlob);
                    var player = document.getElementById("preview-player");
                    player.src = audioUrl;

                    document.getElementById("preview-box").style.display = "flex";
                    document.getElementById("msg").placeholder = "ÏùåÏÑ± Ï†ÑÏÜ°ÌïòÎ†§Î©¥ [Ï†ÑÏÜ°] ÌÅ¥Î¶≠";
                };

                mediaRecorder.start();
                isRecording = true; // ÏÉÅÌÉú Î≥ÄÍ≤Ω
                document.getElementById("btn-mic").classList.add("recording"); // Îπ®Í∞ÑÎ∂à ÏºúÍ∏∞
            })
            .catch(err => {
                console.error("ÎßàÏù¥ÌÅ¨ ÏóêÎü¨:", err);
                alert("ÎßàÏù¥ÌÅ¨ ÏÇ¨Ïö© Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
            });
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            isRecording = false; // ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.getElementById("btn-mic").classList.remove("recording"); // Îπ®Í∞ÑÎ∂à ÎÅÑÍ∏∞
        }
    }

    function cancelVoice() {
        currentVoiceBlob = null;
        document.getElementById("preview-box").style.display = "none";
        document.getElementById("msg").placeholder = "Î©îÏãúÏßÄ ÏûÖÎ†•...";
        document.getElementById("preview-player").src = "";
    }

    function sendMessage() {
        if (currentVoiceBlob) {
            uploadAndSendVoice();
        } else {
            var msgInput = document.getElementById("msg");
            if (msgInput.value && stompClient) {
                stompClient.send("/pub/chat/message", {}, JSON.stringify({
                    type: 'TALK', roomId: currentRoomId, sender: mySenderName, senderId: mySenderId, message: msgInput.value
                }));
                msgInput.value = '';
            }
        }
    }

    function uploadAndSendVoice() {
        var formData = new FormData();
        formData.append("file", currentVoiceBlob, "voice_msg.webm");

        fetch("/api/file/upload", {
            method: "POST", body: formData
        })
            .then(res => res.json())
            .then(data => {
                if(stompClient) {
                    stompClient.send("/pub/chat/message", {}, JSON.stringify({
                        type: 'VOICE', roomId: currentRoomId, sender: mySenderName, senderId: mySenderId, message: data.url
                    }));
                }
                cancelVoice();
            })
            .catch(err => {
                console.error(err);
                alert("ÏùåÏÑ± Ï†ÑÏÜ° Ïã§Ìå®");
            });
    }

    function showUi(message) {
        var ul = document.getElementById("messageList");
        var li = document.createElement("li");
        var type = message.type;
        var senderId = message.senderId;
        var content = message.message;
        var time = message.time ? message.time : "";

        if (type === 'ENTER' || type === 'QUIT') {
            li.classList.add("message-li", "center");
            li.innerHTML = "<div class='bubble'>" + content + "</div>";
        }
        else if (type === 'VOICE') {
            if (senderId == mySenderId) li.classList.add("message-li", "me");
            else li.classList.add("message-li", "other");

            var audioPlayer = "<audio controls src='" + content + "' style='height:30px; width:200px;'></audio>";

            if(senderId == mySenderId) li.innerHTML = "<span class='time'>" + time + "</span><div class='bubble' style='padding:5px;'>" + audioPlayer + "</div>";
            else li.innerHTML = "<div class='sender'>" + message.sender + "</div><div class='bubble' style='padding:5px;'>" + audioPlayer + "</div><span class='time'>" + time + "</span>";
        }
        else if (type === 'CORRECT') {
            li.innerHTML = "<div class='bubble center'>[Ï≤®ÏÇ≠] " + content + "</div>";
        }
        else {
            if (senderId == mySenderId) {
                li.classList.add("message-li", "me");
                li.innerHTML = "<span class='time'>" + time + "</span><div class='bubble'>" + content + "</div>";
            } else {
                li.classList.add("message-li", "other");
                li.innerHTML = "<div class='sender'>" + message.sender + "</div><div class='bubble' onclick='sendCorrection(\"" + content + "\")'>" + content + "</div><span class='time'>" + time + "</span>";
            }
        }
        ul.appendChild(li);
        window.scrollTo(0, document.body.scrollHeight);
    }

    function checkGrammar() { alert("Î¨∏Î≤ï Í≤ÄÏÇ¨ Í∏∞Îä• Íµ¨ÌòÑ ÌïÑÏöî"); }
    function checkTone() { alert("Ìò∏Í∞êÎèÑ Í≤ÄÏÇ¨ Í∏∞Îä• Íµ¨ÌòÑ ÌïÑÏöî"); }
    function sendCorrection(orig) { console.log("Ï≤®ÏÇ≠ ÏöîÏ≤≠: " + orig); }
    function disconnect() { if(stompClient) stompClient.disconnect(); }
    function loadChatHistory() { fetch("/chat/history/" + currentRoomId).then(r=>r.json()).then(d=>d.forEach(c=>showUi(c))); }
</script>
</body>
</html>