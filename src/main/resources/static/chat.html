<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼ CSS */
        body { background-color: #b2c7d9; font-family: 'Malgun Gothic', sans-serif; }
        .chat-container { width: 400px; margin: 0 auto; background-color: #b2c7d9; padding: 20px; }
        .message-box { list-style: none; padding: 0; margin: 0; }

        .message-li { margin-bottom: 10px; display: flex; flex-direction: column; }

        /* ê³µí†µ ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .bubble {
            display: inline-block;
            padding: 7px 10px;
            border-radius: 10px;
            max-width: 70%;
            font-size: 14px;
            position: relative;
        }

        /* 1. ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½ + ë…¸ë€ìƒ‰) */
        .me { align-items: flex-end; }
        .me .bubble { background-color: #ffeb33; margin-left: 5px; }
        .me .sender { display: none; } /* ë‚´ ì´ë¦„ì€ ì•ˆ ë³´ì—¬ì¤Œ */

        /* 2. ë‚¨ì´ ë³´ë‚¸ ë©”ì‹œì§€ (ì™¼ìª½ + í°ìƒ‰) */
        .other { align-items: flex-start; }
        .other .bubble { background-color: #ffffff; margin-right: 5px; }
        .other .sender { font-size: 12px; margin-bottom: 3px; color: #555; }

        /* 3. ì…ì¥/í‡´ì¥ ë©”ì‹œì§€ (ê°€ìš´ë° ì •ë ¬) */
        .center { align-items: center; }
        .center .bubble { background-color: transparent; color: #555; font-size: 12px; }

        /* ì‹œê°„ í‘œì‹œ */
        .time { font-size: 10px; color: #555; margin-top: 3px; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-area {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 10px; display: flex; justify-content: center;
        }
        #msg { width: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #btn-send { padding: 10px 20px; background-color: #ffeb33; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;}
    </style>
</head>
<body>

<div class="chat-container">
    <h2>ğŸš€ ì±„íŒ…ë°©</h2>
    <div style="margin-bottom: 10px;">
        <button onclick="connect()">ğŸ”Œ ì ‘ì†í•˜ê¸°</button>
        <button onclick="disconnect()">âŒ ë‚˜ê°€ê¸°</button>
    </div>

    <ul id="messageList" class="message-box"></ul>
</div>

<div class="input-area">
    <input type="text" id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥" onkeypress="if(event.keyCode==13) sendMessage()">
    <button id="btn-send" onclick="sendMessage()">ì „ì†¡</button>
</div>

<script>
    var stompClient = null;
    var currentRoomId = "1";

    // â˜… í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë‚´ IDë¥¼ '1'ë¡œ ê°€ì •
    // ì‹¤ì œ ë¡œê·¸ì¸ êµ¬í˜„ì‹œì—ëŠ” ë¡œê·¸ì¸í•œ ìœ ì €ì˜ IDë¥¼ ì—¬ê¸°ì— ë„£ì–´ì•¼ í•¨
    var mySenderId = 1;
    var mySenderName = "íŒ€ì¥ë‹˜";

    function connect() {
        var socket = new WebSocket('ws://localhost:8080/ws/chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 1. êµ¬ë…
            stompClient.subscribe('/sub/chat/room/' + currentRoomId, function (message) {
                showUi(JSON.parse(message.body));
            });

            // 2. ì…ì¥ ì•Œë¦¼
            stompClient.send("/pub/chat/message", {}, JSON.stringify({
                type: 'ENTER',
                roomId: currentRoomId,
                sender: mySenderName,
                senderId: mySenderId,
                message: ''
            }));

            // 3. ê³¼ê±° ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸°
            loadChatHistory();
        });
    }

    function sendMessage() {
        var messageInput = document.getElementById("msg");
        var messageContent = messageInput.value;

        if (messageContent && stompClient) {
            var chatMessage = {
                roomId: currentRoomId,
                sender: mySenderName,
                senderId: mySenderId,
                message: messageContent,
                type: 'TALK'
            };
            stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    }

    // â˜… UI ê·¸ë¦¬ëŠ” í•µì‹¬ í•¨ìˆ˜ (ì¹´í†¡ ìŠ¤íƒ€ì¼ ì ìš©)
    function showUi(message) {
        var ul = document.getElementById("messageList");
        var li = document.createElement("li");

        var type = message.type; // ENTER, TALK, QUIT
        var senderId = message.senderId; // ë³´ë‚¸ ì‚¬ëŒ ID
        var content = message.message;
        var time = message.time ? message.time : "";
        var senderName = message.sender;

        // 1. ì…ì¥/í‡´ì¥ ë©”ì‹œì§€ ì²˜ë¦¬ (ê°€ìš´ë° ì •ë ¬)
        if (type === 'ENTER' || type === 'QUIT') {
            li.classList.add("message-li", "center");
            li.innerHTML = "<div class='bubble'>" + content + "</div>";
        }
        // 2. ì¼ë°˜ ëŒ€í™” ë©”ì‹œì§€
        else {
            // ë‚´ê°€ ë³´ë‚¸ ê±´ì§€ ë‚¨ì´ ë³´ë‚¸ ê±´ì§€ í™•ì¸
            if (senderId == mySenderId) {
                li.classList.add("message-li", "me");
                // ë‚´ ê±°ëŠ” ì´ë¦„ ìˆ¨ê¹€, ì‹œê°„ + ë‚´ìš©
                li.innerHTML = "<div class='bubble'>" + content + " <span class='time'>" + time + "</span></div>";
            } else {
                li.classList.add("message-li", "other");
                // ë‚¨ì˜ ê±°ëŠ” ì´ë¦„ + ë‚´ìš© + ì‹œê°„
                li.innerHTML = "<div class='sender'>" + senderName + "</div>" +
                    "<div class='bubble'>" + content + " <span class='time'>" + time + "</span></div>";
            }
        }

        ul.appendChild(li);

        // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦¬ê¸°
        window.scrollTo(0, document.body.scrollHeight);
    }

    function loadChatHistory() {
        fetch("/chat/history/" + currentRoomId)
            .then(response => response.json())
            .then(data => {
                data.forEach(chat => {
                    showUi(chat);
                });
            });
    }
</script>
</body>
</html>