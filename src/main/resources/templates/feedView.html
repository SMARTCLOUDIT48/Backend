<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
                xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>MUSUBI - 일상 공유</title>
    <link rel="stylesheet" th:href="@{/css/feedView.css}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <div th:replace="~{fragments/header :: header}"></div>
</header>

<main class="feed-container">

    <div class="feed-actions-top">
        <a th:href="@{/board/feedWrite}" class="new-feed-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera" viewBox="0 0 16 16">
                <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4z"/>
                <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5m0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7M3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
            </svg>
            새 일상 공유하기</a>
    </div>

    <div class="feed-wrapper" th:each="feed : ${feedList}">

        <div class="feed-header">
            <div class="user-profile">
                <a th:href="${#authentication.name == feed.memberId} ? @{/member/mypage} : @{/member/userPage/{memberId}(memberId=${feed.memberId})}"
                   style="display: block; cursor: pointer;">
                    <img th:src="${feed.profileImageName != null ? '/images/profile/upload/' + feed.profileImageName : '/images/default_profile.png'}"
                         class="profile-img-sm" alt="프로필">
                </a>
                <div class="user-info">
                    <span class="username" th:text="${feed.writerNickname}">nickname</span>
                    <span class="location" th:text="${feed.nation}">Seoul</span>
                </div>
            </div>

            <button type="button" class="more-btn"
                    th:data-id="${feed.boardId}"
                    th:data-writer="${feed.memberId}"
                    onclick="openFeedModal(this)">•••</button>
        </div>

        <div class="feed-image-area" th:if="${feed.filePath != null}">
            <img th:src="${feed.filePath}" alt="Feed Image">
        </div>

        <br>

        <div class="feed-caption">
            <span class="username" th:text="${feed.writerNickname}">nickname</span>
            <span class="caption-text" th:text="${feed.content}">오늘 날씨가 참 좋네요.</span>
        </div>

        <div class="feed-action-bar">
            <div class="left-actions">
                <button type="button" class="icon-btn heart-btn"
                        th:id="'likeBtn-' + ${feed.boardId}"
                        th:classappend="${feed.liked} ? 'active' : ''"
                        th:onclick="|toggleLike(${feed.boardId})|">

                    <svg th:if="${feed.liked}" aria-label="좋아요 취소" color="#ed4956" fill="#ed4956" height="24" role="img" viewBox="0 0 48 48" width="24">
                        <path d="M34.6 3.1c-4.5 0-7.9 1.8-10.6 5.6-2.7-3.7-6.1-5.5-10.6-5.5C6 3.1 0 9.6 0 17.6c0 7.3 5.4 12 10.6 16.5.6.5 1.3 1.1 1.9 1.7l2.3 2c4.4 3.9 6.6 5.9 7.6 6.5.5.3 1.1.5 1.6.5s1.1-.2 1.6-.5c1-.6 3.2-2.6 7.6-6.5l2.3-2c.6-.6 1.3-1.2 1.9-1.7 5.2-4.5 10.6-9.2 10.6-16.5 0-8-6-14.5-13.4-14.5z"></path>
                    </svg>

                    <svg th:unless="${feed.liked}" aria-label="좋아요" color="rgb(38, 38, 38)" fill="rgb(38, 38, 38)" height="24" role="img" viewBox="0 0 24 24" width="24">
                        <path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.956-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path>
                    </svg>
                </button>

                <button type="button" class="icon-btn comment-btn">
                    <svg aria-label="댓글" color="rgb(38, 38, 38)" fill="rgb(38, 38, 38)" height="24" role="img" viewBox="0 0 24 24" width="24">
                        <path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="feed-likes">
            좋아요 <span th:id="'likeCount-' + ${feed.boardId}" th:text="${feed.likeCnt}"></span>개
        </div>

        <div class="feed-meta">
            <a href="#" class="view-comments">댓글 모두 보기</a>
            <span class="time-ago" th:text="${#temporals.format(feed.createdDate, 'yyyy-MM-dd HH:mm')}">2시간 전</span>
        </div>

    </div>

    <div class="no-feed" th:if="${feedList.isEmpty()}">
        <p>아직 공유된 일상이 없습니다.<br>첫 번째 일상을 공유해보세요!</p>
    </div>

    <div class="pagination-area" id="paginationArea" th:if="${!feedList.last}" style="text-align: center; margin: 20px 0;">
        <button type="button" class="load-more-btn" onclick="loadMoreFeeds()">더 보기 +</button>
    </div>

</main>

<footer>
    <div th:replace="~{fragments/footer :: footer}"></div>
</footer>

<div id="feedModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div id="ownerActions" style="display: none;">
            <button type="button" class="modal-btn" onclick="updateFeed()">수정</button>
            <button type="button" class="modal-btn delete" onclick="deleteFeed()">삭제</button>
        </div>

        <button type="button" class="modal-btn" onclick="viewUserInfo()">이 계정 정보</button>
        <button type="button" class="modal-btn cancel" onclick="closeFeedModal()">취소</button>
    </div>
</div>

<input type="hidden" id="selectedFeedId">
<input type="hidden" id="selectedFeedWriter">

<input type="hidden" id="loginUserId"
       th:value="${#authentication.name}"
       th:if="${#authorization.expression('isAuthenticated()')}">

<script>
    // 1. 모달 열기
    function openFeedModal(btn) {
        const feedId = btn.getAttribute('data-id');
        const writerId = btn.getAttribute('data-writer');

        // 선택된 피드 정보 저장
        document.getElementById('selectedFeedId').value = feedId;
        document.getElementById('selectedFeedWriter').value = writerId;

        // 로그인 사용자 ID 가져오기 (비로그인 시 빈 값)
        const loginInput = document.getElementById('loginUserId');
        const currentUserId = loginInput ? loginInput.value : "";

        // 본인 글인지 확인 후 버튼 노출 제어
        const ownerActions = document.getElementById('ownerActions');
        if (currentUserId && currentUserId === writerId) {
            ownerActions.style.display = 'block'; // 본인이면 보이기
        } else {
            ownerActions.style.display = 'none';  // 아니면 숨기기
        }

        // 모달 표시
        document.getElementById('feedModal').style.display = 'flex';
        // 스크롤 방지
        document.body.style.overflow = 'hidden';
    }

    // 2. 모달 닫기
    function closeFeedModal() {
        document.getElementById('feedModal').style.display = 'none';
        document.body.style.overflow = 'auto'; // 스크롤 복구
    }

    // 3. 모달 배경 클릭 시 닫기
    document.getElementById('feedModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeFeedModal();
        }
    });

    // --- 기능 함수들 ---

    // 피드 삭제
    function deleteFeed() {
        if(!confirm("정말 이 게시글을 삭제하시겠습니까?")) return;

        const feedId = document.getElementById('selectedFeedId').value;

        // POST 방식으로 삭제 요청 (가상 폼 생성)
        const form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", "/board/feedDelete");

        const input = document.createElement("input");
        input.setAttribute("type", "hidden");
        input.setAttribute("name", "boardId");
        input.setAttribute("value", feedId);

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    // 피드 수정
    function updateFeed() {
        const feedId = document.getElementById('selectedFeedId').value;
        location.href = '/board/feedUpdate/' + feedId;
    }

    // 계정 정보 보기 (예시)
    function viewUserInfo() {
        // 1. 선택된 피드의 작성자 ID 가져오기
        const writerId = document.getElementById('selectedFeedWriter').value;

        // 2. 현재 로그인한 사용자 ID 가져오기
        const loginInput = document.getElementById('loginUserId');
        const currentUserId = loginInput ? loginInput.value : "";

        // 3. 본인 여부 확인 후 페이지 이동
        if (currentUserId && currentUserId === writerId) {
            // 로그인 했고, 본인 글인 경우 -> 마이페이지로 이동
            location.href = '/member/mypage';
        } else {
            // 그 외 (로그인 안했거나 타인 글) -> 해당 유저의 페이지로 이동
            location.href = '/member/userPage/' + writerId;
        }
    }

    function toggleLike(boardId) {
        // [SVG 상수 정의]
        // 1. 빨간 하트 (Instagram Style)
        const filledHeartSvg = `<svg aria-label="좋아요 취소" color="#ed4956" fill="#ed4956" height="24" role="img" viewBox="0 0 48 48" width="24"><path d="M34.6 3.1c-4.5 0-7.9 1.8-10.6 5.6-2.7-3.7-6.1-5.5-10.6-5.5C6 3.1 0 9.6 0 17.6c0 7.3 5.4 12 10.6 16.5.6.5 1.3 1.1 1.9 1.7l2.3 2c4.4 3.9 6.6 5.9 7.6 6.5.5.3 1.1.5 1.6.5s1.1-.2 1.6-.5c1-.6 3.2-2.6 7.6-6.5l2.3-2c.6-.6 1.3-1.2 1.9-1.7 5.2-4.5 10.6-9.2 10.6-16.5 0-8-6-14.5-13.4-14.5z"></path></svg>`;

        // 2. 빈 하트 (Original)
        const emptyHeartSvg = `<svg aria-label="좋아요" color="rgb(38, 38, 38)" fill="rgb(38, 38, 38)" height="24" role="img" viewBox="0 0 24 24" width="24"><path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.956-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path></svg>`;

        // 로그인 확인
        const loginInput = document.getElementById('loginUserId');
        if (!loginInput || !loginInput.value) {
            if(confirm("로그인이 필요한 서비스입니다. 로그인 하시겠습니까?")) {
                location.href = '/login';
            }
            return;
        }

        // AJAX 요청
        fetch('/board/like/' + boardId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.status === 401) {
                alert("로그인이 필요합니다.");
                return;
            }
            return response.json();
        })
        .then(data => {
            const likeBtn = document.getElementById('likeBtn-' + boardId);
            const likeCountSpan = document.getElementById('likeCount-' + boardId);

            if (data.liked) {
                likeBtn.classList.add('active');
                likeBtn.innerHTML = filledHeartSvg; // 내부 SVG만 교체
            } else {
                likeBtn.classList.remove('active');
                likeBtn.innerHTML = emptyHeartSvg;  // 내부 SVG만 교체
            }

            likeCountSpan.innerText = data.likeCount;
        })
        .catch(error => console.error('Error:', error));
    }

    // 피드 더보기 구현

    /*<![CDATA[*/

    // 변수 초기화
    // 서버에서 현재 페이지 번호를 받아서 저장합니다. (처음엔 0)
    let currentPage = [[${feedList.number}]];

    // 더보기 함수
    function loadMoreFeeds() {
        currentPage++; // 다음 페이지 번호

        fetch('/board/api/feedList?page=' + currentPage)
        .then(response => response.json())
        .then(data => {
            const feedContainer = document.querySelector('.feed-container'); // 피드 전체 감싸는 부모 태그
            const paginationArea = document.getElementById('paginationArea');

            // 1. 받아온 데이터 반복
            data.content.forEach(feed => {

                // (1) 프로필 이미지 경로 처리
                let profileSrc = '/images/default_profile.png';
                if (feed.profileImageName) {
                    // /files/ 가 섞여있다면 제거 (방어 코드)
                    const cleanName = feed.profileImageName.replace('/files/', '');
                    profileSrc = '/images/profile/upload/' + cleanName;
                }

                // (2) 날짜 포맷팅 (YYYY-MM-DD HH:mm)
                let dateStr = "";
                if(feed.createdDate) {
                    const d = new Date(feed.createdDate);
                    // 간단 포맷팅 예시
                    dateStr = d.toISOString().slice(0,16).replace('T', ' ');
                }

                // (3) 좋아요 아이콘 선택 (liked 여부에 따라)
                // 꽉 찬 하트 (빨강)
                const filledHeart = `<svg aria-label="좋아요 취소" color="#ed4956" fill="#ed4956" height="24" role="img" viewBox="0 0 48 48" width="24"><path d="M34.6 3.1c-4.5 0-7.9 1.8-10.6 5.6-2.7-3.7-6.1-5.5-10.6-5.5C6 3.1 0 9.6 0 17.6c0 7.3 5.4 12 10.6 16.5.6.5 1.3 1.1 1.9 1.7l2.3 2c4.4 3.9 6.6 5.9 7.6 6.5.5.3 1.1.5 1.6.5s1.1-.2 1.6-.5c1-.6 3.2-2.6 7.6-6.5l2.3-2c.6-.6 1.3-1.2 1.9-1.7 5.2-4.5 10.6-9.2 10.6-16.5 0-8-6-14.5-13.4-14.5z"></path></svg>`;

                // 빈 하트 (검정)
                const emptyHeart = `<svg aria-label="좋아요" color="rgb(38, 38, 38)" fill="rgb(38, 38, 38)" height="24" role="img" viewBox="0 0 24 24" width="24"><path d="M16.792 3.904A4.989 4.989 0 0 1 21.5 9.122c0 3.072-2.652 4.956-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 0 1 4.708-5.218 4.21 4.21 0 0 1 3.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 0 1 3.679-1.938m0-2a6.04 6.04 0 0 0-4.797 2.127 6.052 6.052 0 0 0-4.787-2.127A6.985 6.985 0 0 0 .5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 0 0 3.518 3.018 2 2 0 0 0 2.174 0 45.263 45.263 0 0 0 3.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 0 0-6.708-7.218Z"></path></svg>`;

                // (4) HTML 조립 (주의: 기존 feedView.html 구조와 동일해야 CSS 적용됨)
                const feedHtml = `
                    <div class="feed-wrapper">
                        <div class="feed-header">
                            <div class="user-profile">
                                <a href="/member/userPage/${feed.memberId}" style="display: block; cursor: pointer;">
                                    <img src="${profileSrc}" class="profile-img-sm" alt="프로필">
                                </a>
                                <div class="user-info">
                                    <span class="username">${feed.writerNickname}</span>
                                    <span class="location">${feed.nation || ''}</span>
                                </div>
                            </div>
                            <button type="button" class="more-btn" data-id="${feed.boardId}" data-writer="${feed.memberId}" onclick="openFeedModal(this)">•••</button>
                        </div>

                        ${feed.filePath ? `<div class="feed-image-area"><img src="${feed.filePath}" alt="Feed Image"></div>` : ''}

                        <br>

                        <div class="feed-caption">
                            <span class="username">${feed.writerNickname}</span>
                            <span class="caption-text">${feed.content}</span>
                        </div>

                        <div class="feed-action-bar">
                            <div class="left-actions">
                                <button type="button" class="icon-btn heart-btn ${feed.liked ? 'active' : ''}"
                                        id="likeBtn-${feed.boardId}"
                                        onclick="toggleLike(${feed.boardId})">
                                    ${feed.liked ? filledHeart : emptyHeart}
                                </button>
                                <button type="button" class="icon-btn comment-btn">
                                    <svg aria-label="댓글" color="rgb(38, 38, 38)" fill="rgb(38, 38, 38)" height="24" role="img" viewBox="0 0 24 24" width="24"><path d="M20.656 17.008a9.993 9.993 0 1 0-3.59 3.615L22 22Z" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"></path></svg>
                                </button>
                            </div>
                        </div>

                        <div class="feed-likes">
                            좋아요 <span id="likeCount-${feed.boardId}">${feed.likeCnt}</span>개
                        </div>

                        <div class="feed-meta">
                            <a href="#" class="view-comments">댓글 모두 보기</a>
                            <span class="time-ago">${dateStr}</span>
                        </div>
                    </div>
                `;

                // 2. 조립된 HTML을 버튼 영역 바로 앞에(목록 끝에) 추가
                paginationArea.insertAdjacentHTML('beforebegin', feedHtml);
            });

            // 3. 마지막 페이지면 버튼 숨김
            if (data.last) {
                paginationArea.style.display = 'none';
            }
        })
        .catch(err => {
            console.error(err);
            alert("더 이상 불러올 게시글이 없거나 오류가 발생했습니다.");
        });
    }

    /*]]>*/

</script>

</body>
</html>