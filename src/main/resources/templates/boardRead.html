<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Musubi - ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°</title>
    <link rel="stylesheet" th:href="@{/css/boardRead.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <div th:replace="~{fragments/header :: header}"></div>
</header>

<main class="read-container">
    <input type="hidden" id="loginUserId" th:value="${#authentication.name}">

    <div class="read-wrapper">

        <div class="post-header">
            <span class="category-badge" th:text="${board.categoryName}">ì¹´í…Œê³ ë¦¬</span>
            <h1 class="post-title" th:text="${board.title}">ê²Œì‹œê¸€ ì œëª©ì…ë‹ˆë‹¤.</h1>

            <div class="writer-info">
                <a th:href="${#authentication.name == board.memberId} ? @{/member/mypage} : @{/member/userPage/{memberId}(memberId=${board.memberId})}"
                   style="display: block; cursor: pointer;">
                    <img th:src="${board.profileImageName != null ? '/images/profile/upload/' + board.profileImageName : '/images/default_profile.png'}"
                         class="profile-img-sm" alt="í”„ë¡œí•„">
                </a>
                <div class="info-text">
                    <span class="nickname" th:text="${board.writerNickname}">ì‘ì„±ì</span>
                    <span class="location" th:text="${board.nation}"
                          style="font-size: 11px; color: #666; margin-top: 2px; display: inline-block;"></span>
                    <span class="meta-date">
                        <span th:text="${#temporals.format(board.createdDate, 'yyyy-MM-dd HH:mm')}">2026-01-22</span>
                        &nbsp;Â·&nbsp; ì¡°íšŒ <span th:text="${board.viewCount}">10</span>
                    </span>
                </div>

                <div class="post-actions"
                     th:if="${#authorization.expression('isAuthenticated()') and #authentication.name == board.memberId}">
                    <button class="action-btn"
                            th:onclick="|location.href='@{/board/update/}' + ${board.boardId}|">ìˆ˜ì •</button>
                    <button class="action-btn delete"
                            th:onclick="|deleteBoard(${board.boardId})|">ì‚­ì œ</button>
                </div>
            </div>
        </div>

        <hr class="divider">

        <div class="post-content">
            <div class="attachment-area" th:if="${board.filePath != null and board.fileName != null}"
                 th:with="lowerName=${#strings.toLowerCase(board.fileName)},
                  isImage=${#strings.endsWith(lowerName, '.jpg') or
                            #strings.endsWith(lowerName, '.jpeg') or
                            #strings.endsWith(lowerName, '.png') or
                            #strings.endsWith(lowerName, '.gif') or
                            #strings.endsWith(lowerName, '.webp')}">

                <div class="image-display" th:if="${isImage}">
                    <img th:src="${board.filePath}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">
                </div>

                <div class="file-display" th:unless="${isImage}">
                    <div class="file-box">
                        <span class="file-icon">ğŸ“</span> <div class="file-info">
                        <span class="file-label">ì²¨ë¶€íŒŒì¼</span>
                        <a th:href="${board.filePath}" th:download="${board.fileName}" class="file-name" th:text="${board.fileName}">
                            files.zip
                        </a>
                    </div>
                        <a th:href="${board.filePath}" th:download="${board.fileName}" class="download-btn">â¬‡ï¸</a>
                    </div>
                </div>
            </div>
            <div class="text-area" th:utext="${#strings.replace(board.content, '
', '&lt;br&gt;')}">
                ë³¸ë¬¸ ë‚´ìš©ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.
            </div>
        </div>

        <br>

        <div class="reaction-area">
            <button class="like-btn" id="likeBtn"
                    th:classappend="${board.liked} ? 'active' : ''"
                    th:onclick="|toggleLike(${board.boardId})|">
                <span class="heart-icon">
            <svg th:if="${board.liked}" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
            </svg>

            <svg th:unless="${board.liked}" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
            </svg>
                </span>
                <span id="likeCount" th:text="${board.likeCnt}">0</span>
            </button>
        </div>

        <hr class="divider">

        <div class="comment-section">
            <h3>ëŒ“ê¸€ <span id="commentCount" th:text="${board.comments != null ? board.comments.size() : 0}">0</span></h3>

            <div class="comment-form">
                <input type="text" id="commentContent" placeholder="ë”°ëœ»í•œ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."
                       th:disabled="${#authentication.name == 'anonymousUser'}">

                <button type="button" onclick="writeComment()">ë“±ë¡</button>
            </div>

            <div class="comment-list" id="commentList">
                <div class="comment-item" th:each="comment : ${board.comments}" th:id="'comment-item-' + ${comment.commentId}">

                    <a th:href="${#authentication.name == comment.memberId} ? @{/member/mypage} : @{/member/userPage/{id}(id=${comment.memberId})}"
                       style="display: block; cursor: pointer;">
                        <img th:src="${comment.writerProfileImage != null ? '/images/profile/upload/' + #strings.replace(comment.writerProfileImage, '/files/', '') : '/images/default_profile.png'}"
                             class="cmt-profile" alt="í”„ë¡œí•„">
                    </a>

                    <div class="cmt-content">
                        <div class="cmt-header">
                            <span class="cmt-writer" th:text="${comment.writerNickname}">ë‹‰ë„¤ì„</span>
                            <span class="cmt-date" th:text="${#temporals.format(comment.createdDate, 'MM.dd HH:mm')}">ë‚ ì§œ</span>
                        </div>

                        <div class="comment-view" th:id="'comment-view-' + ${comment.commentId}">
                            <p class="cmt-text" th:text="${comment.content}" th:id="'comment-content-' + ${comment.commentId}">ëŒ“ê¸€ ë‚´ìš©</p>

                            <div class="cmt-actions" th:if="${#authentication.name == comment.memberId}">
                                <button type="button" class="btn-edit" th:onclick="|toggleEditBox(${comment.commentId})|">ìˆ˜ì •</button>
                                <button type="button" class="btn-delete" th:onclick="|deleteComment(${comment.commentId})|">ì‚­ì œ</button>
                            </div>
                        </div>

                        <div class="comment-edit-box" th:id="'comment-edit-' + ${comment.commentId}" style="display: none;">
                            <input type="text" class="edit-input" th:id="'edit-input-' + ${comment.commentId}" th:value="${comment.content}">
                            <div class="edit-actions">
                                <button type="button" class="btn-save" th:onclick="|updateComment(${comment.commentId})|">ì €ì¥</button>
                                <button type="button" class="btn-cancel" th:onclick="|toggleEditBox(${comment.commentId})|">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bottom-nav">

            <button th:if="${memberId != null}" type="button" class="list-btn"
                    th:onclick="|location.href='@{/member/userPage/{id}(id=${memberId})}'|">
                ê²Œì‹œê¸€ ëª©ë¡
            </button>

            <button th:unless="${memberId != null}" type="button" class="list-btn"
                    th:onclick="|location.href='@{/board/list}'|">
                ê²Œì‹œê¸€ ëª©ë¡
            </button>

        </div>
    </div>
</main>

<footer>
    <div th:replace="~{fragments/footer :: footer}"></div>
</footer>


<script th:inline="javascript">
    function deleteBoard(boardId) {
        // 1. ì‚¬ìš©ì í™•ì¸
        if (confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚­ì œëœ ê¸€ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {

            // 2. ê°€ìƒì˜ í¼(Form) ìƒì„±í•˜ì—¬ POST ì „ì†¡
            // (GET ë°©ì‹ ë§í¬ ì´ë™ì€ ë³´ì•ˆì— ì·¨ì•½í•˜ë¯€ë¡œ Form ì „ì†¡ì„ ê¶Œì¥í•©ë‹ˆë‹¤)
            var form = document.createElement("form");
            form.setAttribute("method", "post");
            form.setAttribute("action", "/board/delete");

            // ID ê°’ì„ ë‹´ì„ hidden input ìƒì„±
            var input = document.createElement("input");
            input.setAttribute("type", "hidden");
            input.setAttribute("name", "boardId");
            input.setAttribute("value", boardId);


            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }


    function toggleLike(boardId) {
        // [SVG ë¬¸ìì—´ ìƒìˆ˜ ì •ì˜]
        const filledHeartSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/></svg>`;

        const emptyHeartSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/></svg>`;

        // (ë¡œê·¸ì¸ ì²´í¬ ë¡œì§ ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼) ...

        fetch('/board/like/' + boardId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.status === 401) {
                 if(confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    location.href = '/login';
                 }
                 throw new Error("Unauthorized");
            }
            return response.json();
        })
        .then(data => {
            const likeBtn = document.getElementById('likeBtn');
            const heartIconSpan = likeBtn.querySelector('.heart-icon'); // SVGë¥¼ ê°ì‹¸ê³  ìˆëŠ” span
            const likeCount = document.getElementById('likeCount');

            // [ìˆ˜ì •] ë°ì´í„°ì— ë”°ë¼ SVG ì½”ë“œ êµì²´
            if (data.liked) {
                likeBtn.classList.add('active');
                heartIconSpan.innerHTML = filledHeartSvg; // ê½‰ ì°¬ í•˜íŠ¸ SVG ë„£ê¸°
            } else {
                likeBtn.classList.remove('active');
                heartIconSpan.innerHTML = emptyHeartSvg;  // ë¹ˆ í•˜íŠ¸ SVG ë„£ê¸°
            }

            likeCount.innerText = data.likeCount;
        })
        .catch(error => console.error('Error:', error));
    }


    // ëŒ“ê¸€ ì‘ì„± í•¨ìˆ˜ (AJAX)
    function writeComment() {
        const contentInput = document.getElementById('commentContent');
        const content = contentInput.value.trim();
        const boardId = [[${board.boardId}]]; // íƒ€ì„ë¦¬í”„ ë³€ìˆ˜

        if (!content) {
            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            contentInput.focus();
            return;
        }

        const data = {
            boardId: boardId,
            content: content
        };

        fetch('/comment/write', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.status === 401) {
                if(confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    location.href = '/member/login';
                }
                throw new Error("Unauthorized");
            }
            if (!response.ok) throw new Error("Server Error");
            return response.json();
        })
        .then(newComment => {
            const commentList = document.getElementById('commentList');

            // 1. í”„ë¡œí•„ ì´ë¯¸ì§€ ê²½ë¡œ ì²˜ë¦¬
            // (HTMLì˜ #strings.replace ë¡œì§ì„ JSë¡œ êµ¬í˜„)
            let profileSrc = '/images/default_profile.png';
            if (newComment.writerProfileImage) {
                // /files/ ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ì œê±°
                const cleanPath = newComment.writerProfileImage.replace('/files/', '');
                profileSrc = '/images/profile/upload/' + cleanPath;
            }

            // 2. ë‚ ì§œ í¬ë§·íŒ… (MM.dd HH:mm)
            let dateStr = "ë°©ê¸ˆ ì „";
            if(newComment.createdDate) {
                try {
                    const date = new Date(newComment.createdDate);
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    dateStr = `${month}.${day} ${hour}:${minute}`;
                } catch(e) {}
            }

            // 3. [í•µì‹¬] ë³¸ì¸ í™•ì¸ ë¡œì§
            const loginUserId = document.getElementById('loginUserId').value;
            const isMyComment = (loginUserId === newComment.memberId);

            // 4. ë²„íŠ¼ HTML ìƒì„± (ë³¸ì¸ì¼ ë•Œë§Œ)
            let buttonsHtml = '';
            if (isMyComment) {
                buttonsHtml = `
                    <div class="cmt-actions">
                        <button type="button" class="btn-edit" onclick="toggleEditBox(${newComment.commentId})">ìˆ˜ì •</button>
                        <button type="button" class="btn-delete" onclick="deleteComment(${newComment.commentId})">ì‚­ì œ</button>
                    </div>
                `;
            }

            // 5. ì „ì²´ HTML ì¡°ë¦½ (ìˆ˜ì •ì°½ í¬í•¨)
            const commentHtml = `
                <div class="comment-item" id="comment-item-${newComment.commentId}">
                    <a href="${isMyComment ? '/member/mypage' : '/member/userPage/' + newComment.memberId}"
                       style="display: block; cursor: pointer;">
                        <img src="${profileSrc}" class="cmt-profile" alt="í”„ë¡œí•„">
                    </a>

                    <div class="cmt-content">
                        <div class="cmt-header">
                            <span class="cmt-writer">${newComment.writerNickname}</span>
                            <span class="cmt-date">${dateStr}</span>
                        </div>

                        <div class="comment-view" id="comment-view-${newComment.commentId}">
                            <p class="cmt-text" id="comment-content-${newComment.commentId}">${newComment.content}</p>
                            ${buttonsHtml} </div>

                        <div class="comment-edit-box" id="comment-edit-${newComment.commentId}" style="display: none;">
                            <input type="text" class="edit-input" id="edit-input-${newComment.commentId}" value="${newComment.content}">
                            <div class="edit-actions">
                                <button type="button" class="btn-save" onclick="updateComment(${newComment.commentId})">ì €ì¥</button>
                                <button type="button" class="btn-cancel" onclick="toggleEditBox(${newComment.commentId})">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ëª©ë¡ ë§¨ ëì— ì¶”ê°€
            commentList.insertAdjacentHTML('beforeend', commentHtml);

            // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° ì¹´ìš´íŠ¸ ì¦ê°€
            contentInput.value = '';
            const countSpan = document.getElementById('commentCount');
            if(countSpan) countSpan.innerText = parseInt(countSpan.innerText) + 1;
        })
        .catch(error => console.error('Error:', error));
    }

    // ëŒ“ê¸€ ìˆ˜ì •ì°½ í† ê¸€ í•¨ìˆ˜ (ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°)
    function toggleEditBox(commentId) {
        const viewArea = document.getElementById('comment-view-' + commentId);
        const editArea = document.getElementById('comment-edit-' + commentId);

        // í˜„ì¬ display ìƒíƒœë¥¼ í™•ì¸í•´ì„œ í† ê¸€
        if (editArea.style.display === 'none') {
            viewArea.style.display = 'none';
            editArea.style.display = 'block';
        } else {
            viewArea.style.display = 'block';
            editArea.style.display = 'none';
            // ì·¨ì†Œ ì‹œ ì…ë ¥ì°½ ê°’ì„ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
            const originalContent = document.getElementById('comment-content-' + commentId).innerText;
            document.getElementById('edit-input-' + commentId).value = originalContent;
        }
    }

    // ëŒ“ê¸€ ìˆ˜ì • ìš”ì²­ (AJAX)
    function updateComment(commentId) {
        const inputField = document.getElementById('edit-input-' + commentId);
        const newContent = inputField.value.trim();

        if (!newContent) {
            alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch('/comment/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                commentId: commentId,
                content: newContent
            })
        })
        .then(response => {
            if (response.status === 401) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }
            if (!response.ok) throw new Error("Update failed");
            return response.json();
        })
        .then(updatedComment => {
            // í™”ë©´ ê°±ì‹ : P íƒœê·¸ ë‚´ìš© ë³€ê²½
            const contentP = document.getElementById('comment-content-' + commentId);
            contentP.innerText = updatedComment.content;

            // ìˆ˜ì •ì°½ ë‹«ê³  ì›ë˜ í™”ë©´ ë³´ì—¬ì£¼ê¸°
            toggleEditBox(commentId);
        })
        .catch(error => {
            console.error('Error:', error);
            alert("ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // ëŒ“ê¸€ ì‚­ì œ ìš”ì²­ (AJAX)
   function deleteComment(commentId) {
        if (!confirm("ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch('/comment/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ commentId: commentId })
        })
        .then(response => {
            if (response.status === 401) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }
            if (!response.ok) {
                // ê¶Œí•œ ì—†ìŒ ë“± ì—ëŸ¬ ì²˜ë¦¬
                return response.text().then(text => { throw new Error(text) });
            }
            return response.text();
        })
        .then(message => {
            // ì„±ê³µ ì‹œ í™”ë©´ì—ì„œ ìš”ì†Œ ì œê±° (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì‚­ì œ)
            const commentItem = document.getElementById('comment-item-' + commentId);
            if (commentItem) {
                commentItem.remove();
            }

            // ì „ì²´ ëŒ“ê¸€ ê°œìˆ˜ ê°ì†Œ
            const countSpan = document.getElementById('commentCount');
            if (countSpan) {
                let currentCount = parseInt(countSpan.innerText);
                if (!isNaN(currentCount) && currentCount > 0) {
                    countSpan.innerText = currentCount - 1;
                }
            }
        })
    }

</script>
</body>
</html>