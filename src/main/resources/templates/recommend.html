<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>íŒŒíŠ¸ë„ˆ ì¶”ì²œ</title>
	<link rel="stylesheet" th:href="@{/css/layout.css}">
	<link rel="stylesheet" th:href="@{/css/recommend/recommend.css}" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.2.1/css/flag-icons.min.css" />

	<script>
		window.addEventListener('DOMContentLoaded', () => {
			loadRecommend();
			
			document.getElementById('recommendTbody').addEventListener('click', async (e) => {
				const chat_partner_btn = e.target.closest('.chat-btn');
				if (!chat_partner_btn) return;

				const partnerId = chat_partner_btn.dataset.userId;
				chat_partner_btn.disabled = true;

				try {
					const res = await fetch(`/api/chat/rooms/direct/${partnerId}`, { method: 'POST' });
					if (!res.ok) throw new Error('HTTP ' + res.status);

					const data = await res.json();
					// ì±„íŒ… í˜ì´ì§€ ë¼ìš°íŒ… ê·œì¹™ì— ë§ê²Œ ìˆ˜ì •
					location.href = `/chat/room/${data.roomId}`;

				} catch (err) {
					console.error(err);
					alert('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨');
					chat_partner_btn.disabled = false;
				}
			});

			const btn = document.getElementById('auto_matching');
			
			// btn.addEventListener('click', async () => {
			// 	btn.disabled = true;

			// 	try {
			// 		// âœ… í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ í•„í„° ì¡°ê±´ì„ ê°™ì´ ë³´ëƒ…ë‹ˆë‹¤.
			// 		// ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ìœ ì € ê¸°ì¤€ìœ¼ë¡œ ìë™ ê³„ì‚°í•œë‹¤ë©´ body ì—†ì´ ë³´ë‚´ë„ ë©ë‹ˆë‹¤.
			// 		const payload = {
			// 			// ì˜ˆì‹œ(ì„ íƒ): ì„œë²„ê°€ criteriaKeyë¥¼ ìš”êµ¬í•œë‹¤ë©´ ì „ë‹¬
			// 			// criteriaKey: "g=FEMALE|n=JAPAN|s=KOREAN|l=ANY"
			// 		};

			// 		const res = await fetch('/api/match/start', {
			// 			method: 'POST',
			// 			headers: { 'Content-Type': 'application/json' },
			// 			body: JSON.stringify(payload) // payloadê°€ í•„ìš” ì—†ìœ¼ë©´ ì´ ì¤„ ì œê±° ê°€ëŠ¥
			// 		});

			// 		if (!res.ok) {
			// 			throw new Error('HTTP ' + res.status);
			// 		}

			// 		const data = await res.json();
			// 		// data ì˜ˆì‹œ:
			// 		// { status: "WAITING" }
			// 		// { status: "MATCHED", roomId: 10, roomUuid: "....", partnerId: 2 }

			// 		if (data.status === 'MATCHED') {
			// 			// âœ… ì±„íŒ…ë°© í˜ì´ì§€ ê·œì¹™ì— ë§ê²Œ ìˆ˜ì •
			// 			// roomUuidë¡œ ì´ë™í•˜ëŠ” êµ¬ì¡°ë¼ë©´:
			// 			location.href = `/chat/room/${data.roomUuid}`;
			// 			return;
			// 		}

			// 		// WAITINGì´ë©´ í´ë§ ì‹œì‘(1ì´ˆë§ˆë‹¤ ë§¤ì¹­ ê²°ê³¼ í™•ì¸)
			// 		startPollingForMatch(btn);

			// 	} catch (err) {
			// 		console.error(err);
			// 		alert('ë§¤ì¹­ ì‹œì‘ ì‹¤íŒ¨');
			// 		btn.disabled = false;
			// 	}
			// });

		});

		function startPollingForMatch(btn) {
				const intervalMs = 1000;

				const timer = setInterval(async () => {
					try {
						const res = await fetch('/api/match/result');
						if (!res.ok) throw new Error('HTTP ' + res.status);

						const data = await res.json();

						if (data.status === 'MATCHED') {
							clearInterval(timer);
							location.href = `/chat/room/${data.roomUuid}`;
						}
					} catch (err) {
						console.error(err);
						// í´ë§ ì¤‘ ì—ëŸ¬ê°€ ë‚˜ë„ ê³„ì† ì‹œë„í• ì§€/ì¤‘ë‹¨í• ì§€ ì„ íƒ ê°€ëŠ¥
						// ì—¬ê¸°ì„œëŠ” 3íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨ ê°™ì€ ì •ì±…ì„ ë‘˜ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
					}
				}, intervalMs);

				// (ì„ íƒ) ì·¨ì†Œ ë²„íŠ¼ì´ ìˆìœ¼ë©´ clearInterval(timer)ë¡œ ì¤‘ë‹¨í•˜ê²Œ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.
			}

		async function loadRecommend() {
			try {
				const response = await fetch('/api/recommend');

				if (!response.ok) {
					throw new Error('HTTP error ' + response.status);
				}
				const list = await response.json();
				console.log(list);
				renderRecommend(list);

			} catch (e) {
				console.log(e);
			}
		}

		

		function renderRecommend(list) {
			const recommendList = document.getElementById('recommendTbody');
			let html = '';

			list.forEach(item => {

				let flagStatus = "";
				let study = "";
				let languageLevel = "";
				let nation = "";
				let imagePath = item.profileImagePath + "/" + item.profileImageName;
				console.log(item.id);

				switch (item.nativeLanguage) {
					case "KOREAN":
						flagStatus = "fi fi-kr flag-icon";
						break;
					case "JAPANESE":
						flagStatus = "fi fi-jp flag-icon";
						break;
					default:
						flagStatus = "default"
						break;
				}

				switch (item.studyLanguage) {
					case "KOREAN":
						study = "fi fi-kr";
						break;
					case "JAPANESE":
						study = "fi fi-jp";
						break;
					default:
						study = "default"
						break;
				}

				switch (item.nation) {

					case "KOREA":
						nation = "í•œêµ­";
						break;
					case "JAPAN":
						nation = "ì¼ë³¸";
						break;
					default:
						nation = "default"
						break;
				}

				switch (item.levelLanguage) {
					case 'BEGINNER':
						languageLevel = "â˜…â˜†â˜†â˜†"
						break;
					case 'INTERMEDIATE':
						languageLevel = "â˜…â˜…â˜†â˜†"
						break;
					case 'ADVANCED':
						languageLevel = "â˜…â˜…â˜…â˜†"
						break;
					case 'NATIVE':
						languageLevel = "â˜…â˜…â˜…â˜…"
						break;
					default:
						languageLevel = "â˜…â˜†â˜†â˜†"
				}


				html += `
            	<div class="member-card">
			<div class="profile-wrap">
				<img src="${imagePath}" class="profile-img" alt="">
				<span class="${flagStatus}" aria-label="Japan"></span>
			</div>
		
			<!-- ì •ë³´ ì˜ì—­ -->
			<div class="info">
				<div class="nickname">${item.nickname}</div>
		
				<div class="row">
					<span class="label">ê±°ì£¼êµ­ê°€</span>
					<span class="value">${nation}</span>
				</div>
		
				<div class="row">
					<span class="label">í•™ìŠµì–¸ì–´</span>
					<span class="lang">
						<span class="${study}"></span>
						<span class="level">${languageLevel}</span>
					</span>
				</div>
			</div>
		
			<!-- ìš°ì¸¡ ì˜ì—­ -->
			<div class="right">
				<span class="chatting-text">"ì¸ê¸° ë©¤ë²„ì˜ˆìš”! ğŸ”¥ ë‹µì¥ì´ ëŠ¦ì„ ìˆ˜ ìˆì–´ìš”."</span>
				<div class="temp">${item.manner}â„ƒ</div>
				<button class="chat-btn" data-user-id="${item.id}">ì±„íŒ… ì‹ ì²­</button>
			</div>
		</div>
        		`;
			});

			recommendList.innerHTML = html;
		}

		// async function chattingNumber(user_id) {
		// 	try {
		// 		const response = await fetch('/api/chat/partner-activity/{id}');

		// 		if (!response.ok) {
		// 			throw new Error('HTTP error ' + response.status);
		// 		}
		// 		const list = await response.json();
		// 		console.log(list);
		// 		renderRecommend(list);

		// 	} catch (e) {
		// 		console.log(e);
		// 	}
		// }

	</script>
</head>

<body>
	<header>
		<div th:replace="~{fragments/header :: header}"></div>
	</header>

	<section class="hero">
		<h1 class="webTitle">ë¬´ìŠ¤ë¹„</h1>
		<h1 class="SubTitle">ì¶”ì²œ íŒŒíŠ¸ë„ˆ ë¦¬ìŠ¤íŠ¸</h1>
		<p class="temp_context">ì–¸ì–´ ë¦¬ìŠ¤íŠ¸ë¶€í„° ì±„íŒ… ìš”ì²­ê¹Œì§€ ì„œë¹„ìŠ¤ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”(ì„ì‹œ)</p>
	</section>
	<section>
		<button id="auto_matching">ìë™ ë§¤ì¹­</button>
	</section>
	<!-- <section class="filter">
	<h3>ì¡°ê±´ í•„í„°</h3>
	<div class="filter-box">
		<span class="tag">í•œêµ­ì–´</span>
		<span class="tag">30km ì´ë‚´</span>
		<span class="tag green">ì¹­ì°¬</span>
		<span class="tag orange">ì–¸ì œ</span>
		<button class="btn primary">í•„í„° ì ìš©</button>
		<button class="btn">ì´ˆê¸°í™”</button>
	</div>
	</section> -->
	<section class="content">
		<div id="recommendTbody">
		</div>
	</section>
	<footer>
		<div th:replace="~{fragments/footer :: footer}"></div>
	</footer>
</body>

</html>