<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>íŒŒíŠ¸ë„ˆ ì¶”ì²œ</title>
	<link rel="stylesheet" th:href="@{/css/layout.css}">
	<link rel="stylesheet" th:href="@{/css/recommend/recommend.css}" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.2.1/css/flag-icons.min.css" />
	<script>
		window.addEventListener('DOMContentLoaded', () => {
			loadRecommend();

			const ageMin = document.getElementById("ageMin");
			const ageMax = document.getElementById("ageMax");
			const ageMinValue = document.getElementById("ageMinValue");
			const ageMaxValue = document.getElementById("ageMaxValue");
			const ageFill = document.getElementById("ageFill");

			ageMin.addEventListener("input", syncAge);
			ageMax.addEventListener("input", syncAge);

			syncAge();

			document.getElementById('filterForm')?.addEventListener('reset', () => {
				setTimeout(() => {
					syncAge();
				}, 0);
			});


			//ì±„íŒ… ì‹ ì²­ ë²„íŠ¼ìœ¼ë¡œ ì±„íŒ…ë°© ì…ì¥
			document.getElementById('recommendTbody').addEventListener('click', async (e) => {
				const chat_partner_btn = e.target.closest('.chat-btn');
				if (!chat_partner_btn) return;

				const partnerId = chat_partner_btn.dataset.userId;
				chat_partner_btn.disabled = true;

				try {
					const res = await fetch(`/api/chat/rooms/direct/${partnerId}`, { method: 'POST' });
					if (!res.ok) throw new Error('HTTP ' + res.status);

					const data = await res.json();
					// ì±„íŒ… í˜ì´ì§€ ë¼ìš°íŒ… ê·œì¹™ì— ë§ê²Œ ìˆ˜ì •
					// âœ… roomIdë¥¼ ì„ì‹œ ì €ì¥í•˜ê³  /chatìœ¼ë¡œ ì´ë™ (URLì€ /chat ê·¸ëŒ€ë¡œ)
					sessionStorage.setItem('openRoomId', data.roomId);

					location.href = `/chat`;

				} catch (err) {
					console.error(err);
					alert('ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨');
					chat_partner_btn.disabled = false;
				}
			});
			//ìë™ ë§¤ì¹­ ë²„íŠ¼
			const mathch_btn = document.getElementById('auto_matching');

			mathch_btn.addEventListener('click', async () => {
				mathch_btn.disabled = true;

				try {
					const criteriaKey = buildCriteriaKey();
					// criteriaKey: "g=FEMALE|n=JAPAN|s=KOREAN|l=ANY"
					const payload = criteriaKey ? { criteriaKey } : {};
					// âœ… í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ í•„í„° ì¡°ê±´ì„ ê°™ì´ ë³´ëƒ…ë‹ˆë‹¤.
					// ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ìœ ì € ê¸°ì¤€ìœ¼ë¡œ ìë™ ê³„ì‚°í•œë‹¤ë©´ body ì—†ì´ ë³´ë‚´ë„ ë©ë‹ˆë‹¤.
					console.log("Filtering Key");
					console.log(payload);
					const res = await fetch('/api/match/start', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					if (!res.ok) {
						throw new Error('HTTP ' + res.status);
					}

					const data = await res.json();
					console.log("match Start Data");
					console.log(data);
					// data ì˜ˆì‹œ:
					// {status: "WAITING" }
					// {status: "MATCHED", roomId: 10, roomUuid: "....", partnerId: 2 }

					if (data.status === 'MATCHED') {
						// âœ… ì±„íŒ…ë°© í˜ì´ì§€ ê·œì¹™ì— ë§ê²Œ ìˆ˜ì •
						//roomIdë¥¼ ì–´ë””ì„œ ë°›ì•„ì™€ì•¼í•¨
						console.log(data);
						console.log("ë°ì´í„°. roomId" + data.roomId);
						sessionStorage.setItem('openRoomId', data.roomId);
						closeMatchOverlay(); // í˜¹ì‹œ ì—´ë ¤ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ë‹«ê¸°
						location.href = `/chat`;
						return;
					}

					// WAITINGì´ë©´ í´ë§ ì‹œì‘(1ì´ˆë§ˆë‹¤ ë§¤ì¹­ ê²°ê³¼ í™•ì¸)
					openMatchOverlay();
					startPollingForMatch(mathch_btn);

				} catch (err) {
					console.error(err);
					alert('ë§¤ì¹­ ì‹œì‘ ì‹¤íŒ¨');
					closeMatchOverlay(); // í˜¹ì‹œ ì—´ë ¤ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ë‹«ê¸°
					mathch_btn.disabled = false;
				}
			});

			// âœ… ë§¤ì¹­ ì·¨ì†Œ ë²„íŠ¼
			document.getElementById('matchCancelBtn')?.addEventListener('click', async () => {
				stopMatchPolling();
				closeMatchOverlay();

				const mathch_btn = document.getElementById('auto_matching');
				if (mathch_btn) mathch_btn.disabled = false;

				try {
					await fetch('/api/match/cancel', { method: 'POST' });
				} catch (e) {
					console.error('cancel failed', e);
				}
			});

		}); //window.addEventListener('DOMContentLoaded' ëë‚˜ëŠ” ì§€ì 


		//ë°ì´í„° ì¼ê´€ì„±ì„ ìœ„í•´ì„œ ALL > ANYë¡œ ë°”ê¿ˆ
		function toAny(v) {
			if (!v) return 'ANY';
			const up = String(v).toUpperCase();
			return (up === 'ALL') ? 'ANY' : up;
		}

		//í•„í„°ë§ì„ form ì•ˆì— ë‹´ì•„ì„œ í•„í„°ë§í‚¤ë¥¼ ë§Œë“¬
		function buildCriteriaKey() {
			const form = document.getElementById('filterForm');
			if (!form) return null;
			const fd = new FormData(form);

			const g = toAny(fd.get('gender')); // MALE/FEMALE/ANY
			const n = toAny(fd.get('nation')); // KOREA/JAPAN/ANY
			const lang = toAny(fd.get('studyLanguage')); // KOREAN/JAPANESE/ANY

			// ageMin/ageMax inputì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
			const ageMinEl = document.getElementById('ageMin');
			const ageMaxEl = document.getElementById('ageMax');
			let ageMin = ageMinEl ? parseInt(ageMinEl.value, 10) : 18;
			let ageMax = ageMaxEl ? parseInt(ageMaxEl.value, 10) : 80;
			if (Number.isNaN(ageMin)) ageMin = 18;
			if (Number.isNaN(ageMax)) ageMax = 80;
			if (ageMin > ageMax) [ageMin, ageMax] = [ageMax, ageMin];

			const levels = fd.getAll('levels');
			const lv = levels.length ? levels.join(',') : 'ANY';

			// interests: ì²´í¬ëœ ëŒ€ë¶„ë¥˜ InterestType(CULTURE, IT...), ì—†ìœ¼ë©´ ANY
			const interests = fd.getAll('interestTypes');
			const interest = interests.length ? interests.join(',') : 'ANY';

			// ì„œë²„ íŒŒì„œê°€ ê¸°ëŒ€í•˜ëŠ” í‚¤: g, age, n, lang, lv, interest
			return `g=${g}|age=${ageMin}-${ageMax}|n=${n}|lang=${lang}|lv=${lv}|interest=${interest}`;
		}

		function clampSwap(minEl, maxEl) {
			let min = parseFloat(minEl.value);
			let max = parseFloat(maxEl.value);
			if (min > max) {
				[min, max] = [max, min];
				minEl.value = min;
				maxEl.value = max;
			}
			return { min, max };
		}

		function setFill(fillEl, min, max, minLimit, maxLimit) {
			const left = ((min - minLimit) / (maxLimit - minLimit)) * 100;
			const right = ((max - minLimit) / (maxLimit - minLimit)) * 100;
			fillEl.style.left = left + "%";
			fillEl.style.width = (right - left) + "%";
		}

		function syncAge() {
			const { min, max } = clampSwap(ageMin, ageMax);
			ageMinValue.textContent = String(min);
			ageMaxValue.textContent = String(max);
			setFill(ageFill, min, max, 18, 60);
		}

		function startPollingForMatch(mathch_btn) {
			stopMatchPolling(); // âœ… í˜¹ì‹œ ë‚¨ì•„ìˆë˜ í´ë§ ì œê±°

			const intervalMs = 1000;
			const maxMs = 60_000; // 60ì´ˆ
			const startedAt = Date.now();

			const timer = setInterval(async () => {
				try {
					const res = await fetch('/api/match/result');
					if (!res.ok) {
						const body = await res.text(); // âœ… ì„œë²„ê°€ ì¤€ ì—ëŸ¬ ë‚´ìš©
						console.error('match/result failed:', res.status, body);
						throw new Error('HTTP ' + res.status);
					}

					const data = await res.json();

					if (data.status === 'MATCHED') {
						clearInterval(timer);
						//roomIdë¥¼ ì–´ë””ì„œ ë°›ì•„ì™€ì•¼í•¨
						console.log("Polling Data ì „ì²´")
						console.log(data);
						console.log("ë°ì´í„°. roomId" + data.roomId);
						sessionStorage.setItem('openRoomId', data.roomId);
						location.href = `/chat`;
						return;
					}

					// âœ… íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬
					if (Date.now() - startedAt > maxMs) {
						clearInterval(timer);
						alert('ë§¤ì¹­ ëŒ€ê¸° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
						mathch_btn.disabled = false;
					}

				} catch (err) {
					console.error(err);
					// í´ë§ ì¤‘ ì—ëŸ¬ê°€ ë‚˜ë„ ê³„ì† ì‹œë„í• ì§€/ì¤‘ë‹¨í• ì§€ ì„ íƒ ê°€ëŠ¥
					// ì—¬ê¸°ì„œëŠ” 3íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨ ê°™ì€ ì •ì±…ì„ ë‘˜ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
				}
			}, intervalMs);

			// (ì„ íƒ) ì·¨ì†Œ ë²„íŠ¼ì´ ìˆìœ¼ë©´ clearInterval(timer)ë¡œ ì¤‘ë‹¨í•˜ê²Œ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.
		}

		async function loadRecommend() {
			try {
				const response = await fetch('/api/recommend');

				if (!response.ok) {
					throw new Error('HTTP error ' + response.status);
				}
				const list = await response.json();
				console.log("ë§¤ì¹­ ë¦¬ìŠ¤íŠ¸");
				console.log(list);
				renderRecommend(list);

			} catch (e) {
				console.log(e);
			}
		}

		let matchPollingTimer = null;

		function openMatchOverlay() {
			const overlay = document.getElementById('matchOverlay');
			overlay.classList.add('is-open');
			overlay.setAttribute('aria-hidden', 'false');
			document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ì ê¸ˆ
		}

		function closeMatchOverlay() {
			const overlay = document.getElementById('matchOverlay');
			overlay.classList.remove('is-open');
			overlay.setAttribute('aria-hidden', 'true');
			document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µêµ¬
		}

		function stopMatchPolling() {
			if (matchPollingTimer) {
				clearInterval(matchPollingTimer);
				matchPollingTimer = null;
			}
		}


		function renderRecommend(list) {
			const recommendList = document.getElementById('recommendTbody');
			let html = '';

			list.forEach(item => {

				let flagStatus = "";
				let study = "";
				let languageLevel = "";
				let nation = "";
				let imagePath = item.profileImagePath + "/" + item.profileImageName;
				//console.log(item.id);

				switch (item.nativeLanguage) {
					case "KOREAN":
						flagStatus = "fi fi-kr flag-icon";
						break;
					case "JAPANESE":
						flagStatus = "fi fi-jp flag-icon";
						break;
					default:
						flagStatus = "default"
						break;
				}

				switch (item.studyLanguage) {
					case "KOREAN":
						study = "fi fi-kr";
						break;
					case "JAPANESE":
						study = "fi fi-jp";
						break;
					default:
						study = "default"
						break;
				}

				switch (item.nation) {

					case "KOREA":
						nation = "í•œêµ­";
						break;
					case "JAPAN":
						nation = "ì¼ë³¸";
						break;
					default:
						nation = "default"
						break;
				}

				switch (item.levelLanguage) {
					case 'BEGINNER':
						languageLevel = "â˜…â˜†â˜†â˜†"
						break;
					case 'INTERMEDIATE':
						languageLevel = "â˜…â˜…â˜†â˜†"
						break;
					case 'ADVANCED':
						languageLevel = "â˜…â˜…â˜…â˜†"
						break;
					case 'NATIVE':
						languageLevel = "â˜…â˜…â˜…â˜…"
						break;
					default:
						languageLevel = "â˜…â˜†â˜†â˜†"
				}


				html += `
    <div class="member-card">
        <div class="profile-wrap">
            <img src="${imagePath}" class="profile-img" alt="">
                <span class="${flagStatus}" aria-label="Japan"></span>
        </div>

        <!-- ì •ë³´ ì˜ì—­ -->
        <div class="info">
            <div class="nickname">${item.nickname}</div>

            <div class="row">
                <span class="label">ê±°ì£¼êµ­ê°€</span>
                <span class="value">${nation}</span>
            </div>

            <div class="row">
                <span class="label">í•™ìŠµì–¸ì–´</span>
                <span class="lang">
                    <span class="${study}"></span>
                    <span class="level">${languageLevel}</span>
                </span>
            </div>
        </div>

        <!-- ìš°ì¸¡ ì˜ì—­ -->
        <div class="right">
            <span class="chatting-text">"ì¸ê¸° ë©¤ë²„ì˜ˆìš”! ğŸ”¥ ë‹µì¥ì´ ëŠ¦ì„ ìˆ˜ ìˆì–´ìš”."</span>
            <div class="temp">${item.manner}â„ƒ</div>
            <button class="chat-btn" data-user-id="${item.id}">ì±„íŒ… ì‹ ì²­</button>
        </div>
    </div>
    `;
			});

			recommendList.innerHTML = html;
		}

		// async function chattingNumber(user_id) {
		// 	try {
		// 		const response = await fetch('/api/chat/partner-activity/{id}');

		// 		if (!response.ok) {
		// 			throw new Error('HTTP error ' + response.status);
		// 		}
		// 		const list = await response.json();
		// 		console.log(list);
		// 		renderRecommend(list);

		// 	} catch (e) {
		// 		console.log(e);
		// 	}
		// }



	</script>
</head>

<body>
	<header>
		<div th:replace="~{fragments/header :: header}"></div>
	</header>

	<section class="hero">
		<h1 class="webTitle">ë¬´ìŠ¤ë¹„</h1>
		<h1 class="SubTitle">ì¶”ì²œ íŒŒíŠ¸ë„ˆ ë¦¬ìŠ¤íŠ¸</h1>
		<p class="temp_context">ì–¸ì–´ ë¦¬ìŠ¤íŠ¸ë¶€í„° ì±„íŒ… ìš”ì²­ê¹Œì§€ ì„œë¹„ìŠ¤ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”(ì„ì‹œ)</p>
	</section>
	<section class="filter-panel" aria-label="ì¶”ì²œ íŒŒíŠ¸ë„ˆ í•„í„°">
		<div class="filter-header">
			<h2 class="filter-title">ì¡°ê±´ í•„í„°</h2>
			<p class="filter-sub">ì›í•˜ëŠ” ì¡°ê±´ì„ ì„ íƒí•´ì„œ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¢í˜€ë³´ì„¸ìš”.</p>
		</div>

		<form id="filterForm" class="filter-grid">
			<!-- 1) ì„±ë³„ -->
			<div class="filter-item">
				<label class="filter-label">ì„±ë³„</label>
				<div class="segmented" role="group" aria-label="ì„±ë³„ ì„ íƒ">
					<input type="radio" name="gender" id="g_all" value="ALL" checked>
					<label for="g_all">ëª¨ë‘</label>

					<input type="radio" name="gender" id="g_male" value="MALE">
					<label for="g_male">ë‚¨</label>

					<input type="radio" name="gender" id="g_female" value="FEMALE">
					<label for="g_female">ì—¬</label>
				</div>
			</div>

			<!-- 2) í•™ìŠµì–¸ì–´ -->
			<div class="filter-item">
				<label class="filter-label">í•™ìŠµì–¸ì–´</label>
				<div class="segmented" role="group" aria-label="í•™ìŠµì–¸ì–´ ì„ íƒ">
					<input type="radio" name="studyLanguage" id="sl_all" value="ALL" checked>
					<label for="sl_all">ëª¨ë‘</label>

					<input type="radio" name="studyLanguage" id="sl_kor" value="KOREAN">
					<label for="sl_kor">í•œêµ­ì–´</label>

					<input type="radio" name="studyLanguage" id="sl_jpn" value="JAPANESE">
					<label for="sl_jpn">ì¼ë³¸ì–´</label>
				</div>
			</div>



			<!-- 3) ê±°ì£¼êµ­ê°€ -->
			<div class="filter-item">
				<label class="filter-label">ê±°ì£¼êµ­ê°€</label>
				<div class="segmented" role="group" aria-label="ê±°ì£¼êµ­ê°€ ì„ íƒ">
					<input type="radio" name="nation" id="n_all" value="ALL" checked>
					<label for="n_all">ëª¨ë‘</label>

					<input type="radio" name="nation" id="n_kor" value="KOREA">
					<label for="n_kor">í•œêµ­</label>

					<input type="radio" name="nation" id="n_jpn" value="JAPAN">
					<label for="n_jpn">ì¼ë³¸</label>
				</div>
			</div>


			<!-- 4) ë‚˜ì´ (ìµœì†Œ/ìµœëŒ€) -->
			<div class="filter-item">
				<label class="filter-label">ë‚˜ì´</label>

				<div class="dual-range" data-range="age">
					<div class="dual-track">
						<span class="dual-fill" id="ageFill"></span>
					</div>

					<div class="dual-inputs">
						<input id="ageMin" name="ageMin" type="range" min="18" max="60" value="20" step="1">
						<input id="ageMax" name="ageMax" type="range" min="18" max="80" value="35" step="1">
					</div>

					<div class="range-meta">
						<span class="chip"><b id="ageMinValue">20</b>ì„¸</span>
						<span class="chip"><b id="ageMaxValue">35</b>ì„¸</span>
					</div>
				</div>
			</div>


			<!-- 5) í•™ìŠµë ˆë²¨(ë³µìˆ˜ ì„ íƒ) -->
			<div class="filter-item">
				<label class="filter-label">í•™ìŠµë ˆë²¨</label>

				<div class="level-chips" role="group" aria-label="í•™ìŠµë ˆë²¨ ì„ íƒ(ë³µìˆ˜)">
					<input type="checkbox" name="levels" id="lv1" value="1">
					<label for="lv1">1</label>

					<input type="checkbox" name="levels" id="lv2" value="2">
					<label for="lv2">2</label>

					<input type="checkbox" name="levels" id="lv3" value="3">
					<label for="lv3">3</label>

					<input type="checkbox" name="levels" id="lv4" value="4">
					<label for="lv4">4</label>
				</div>

				<p class="help">ì›í•˜ëŠ” ë ˆë²¨ë§Œ ì²´í¬í•˜ì„¸ìš”. (ë¯¸ì²´í¬ ì‹œ ì „ì²´ë¡œ ê°„ì£¼)</p>
			</div>

			<!-- 6) ê´€ì‹¬ì‚¬ (ëŒ€ë¶„ë¥˜) -->
			<div class="filter-item">
				<label class="filter-label">ê´€ì‹¬ì‚¬</label>

				<div class="btn-group interest-group">
					<input type="checkbox" name="interestTypes" id="it_culture" value="CULTURE">
					<label for="it_culture" class="filter-btn">ë¬¸í™” Â· ì˜ˆìˆ </label>

					<input type="checkbox" name="interestTypes" id="it_hobby" value="HOBBY">
					<label for="it_hobby" class="filter-btn">ì·¨ë¯¸ Â· ì—¬ê°€</label>

					<input type="checkbox" name="interestTypes" id="it_sport" value="SPORTS">
					<label for="it_sport" class="filter-btn">ìš´ë™ Â· ìŠ¤í¬ì¸ </label>

					<input type="checkbox" name="interestTypes" id="it_travel" value="TRAVEL">
					<label for="it_travel" class="filter-btn">ì—¬í–‰ Â· ì§€ì—­</label>

					<input type="checkbox" name="interestTypes" id="it_food" value="FOOD">
					<label for="it_food" class="filter-btn">ìŒì‹ Â· ìš”ë¦¬</label>

					<input type="checkbox" name="interestTypes" id="it_learning" value="STUDY">
					<label for="it_learning" class="filter-btn">í•™ìŠµ Â· ìê¸°ê³„ë°œ</label>

					<input type="checkbox" name="interestTypes" id="it_tech" value="IT">
					<label for="it_tech" class="filter-btn">IT Â· ê¸°ìˆ </label>

					<input type="checkbox" name="interestTypes" id="it_life" value="LIFESTYLE">
					<label for="it_life" class="filter-btn">ë¼ì´í”„ìŠ¤íƒ€ì¼</label>
				</div>

				<p class="help">í¥ë¯¸ê°€ ìˆëŠ” ê´€ì‹¬ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ë¯¸ì²´í¬ ì‹œ ì „ì²´ë¡œ ê°„ì£¼)</p>
			</div>

			<!-- âœ… ì•¡ì…˜ ë²„íŠ¼ 3ê°œ -->
			<div class="filter-actions">
				<button type="button" id="auto_matching" class="btn primary">
					ìë™ ë§¤ì¹­
				</button>
				<button type="reset" id="refreshBtn" class="btn ghost">
					ì´ˆê¸°í™”? ìƒˆë¡œê³ ì¹¨?
				</button>
				<button type="submit" id="searchBtn" class="btn solid">
					ê²€ìƒ‰
				</button>
			</div>
		</form>
	</section>
	<section class="content">
		<div id="recommendTbody">
		</div>
	</section>
	<footer>
		<div th:replace="~{fragments/footer :: footer}"></div>
	</footer>
	<div id="matchOverlay" class="match-overlay" aria-hidden="true">
		<div class="match-modal" role="dialog" aria-modal="true" aria-labelledby="matchTitle">
			<h3 id="matchTitle" class="match-title">ë§¤ì¹­ì¤‘ì…ë‹ˆë‹¤â€¦</h3>
			<p class="match-sub">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”. (ìµœëŒ€ 60ì´ˆ)</p>

			<div class="match-actions">
				<button type="button" id="matchCancelBtn" class="btn ghost">ì·¨ì†Œ</button>
			</div>
		</div>
	</div>
</body>

</html>